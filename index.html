
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…äººãƒ»å…±ç”¨ç‰ˆ (v9)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'muji-bg': '#F9F9F7',       
                        'muji-text': '#4A4A4A',     
                        'muji-border': '#E0E0E0',   
                        'muji-red': '#7F0019',      
                        'muji-accent': '#9F8C75',
                        'muji-green': '#5F7161',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* === ç„¡å°é¢¨æ ¼æ ¸å¿ƒæ¨£å¼ === */
        body {
            background-color: #F9F9F7;
            color: #4A4A4A;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        .muji-card {
            background: white;
            border: 1px solid #E0E0E0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        
        /* æ–°å¢è³‡è¨Šæ¬„ä½æ¨£å¼ */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #eee;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .info-label { font-size: 10px; color: #999; display: flex; align-items: center; gap: 4px; }
        .info-val { font-size: 12px; color: #4A4A4A; font-weight: 500; line-height: 1.2; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .muji-btn {
            background-color: #4A4A4A;
            color: white;
            border-radius: 4px;
            padding: 12px 16px; /* åŠ å¤§è§¸æ§å€ */
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            transition: background 0.2s;
            display: flex; justify-content: center; items-align: center;
        }
        .muji-btn:active { background-color: #2c2c2c; }
        
        .muji-btn-outline {
            background-color: transparent;
            border: 1px solid #4A4A4A;
            color: #4A4A4A;
            border-radius: 4px;
            padding: 10px 14px;
        }

        /* åº•éƒ¨å°èˆª */
        .nav-item.active {
            color: #7F0019;
            font-weight: 700;
            border-bottom: 2px solid #7F0019;
        }
        .nav-item {
            color: #999;
            padding-bottom: 4px;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tag {
            font-size: 0.75rem;
            padding: 2px 6px;
            border: 1px solid #ddd;
            border-radius: 2px;
            color: #666;
            background: #fcfcfc;
            display: inline-block;
            margin-right: 4px;
        }
        .tag-transport { border-color: #9F8C75; color: #9F8C75; }
        .tag-food { border-color: #7F0019; color: #7F0019; }

        .overview-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; background: white; }
        .overview-table th { text-align: left; padding: 12px 8px; border-bottom: 2px solid #4A4A4A; color: #4A4A4A; font-weight: 700; }
        .overview-table td { padding: 12px 8px; border-bottom: 1px solid #E0E0E0; vertical-align: top; color: #666; }
        .overview-table tr:last-child td { border-bottom: none; }

        .modal-overlay { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(2px); }

        /* å”ä½œç‹€æ…‹ç‡ˆè™Ÿ */
        .sync-status {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px;
        }
        .status-offline { background: #ccc; }
        .status-online { background: #4CAF50; box-shadow: 0 0 5px #4CAF50; }

        @media print {
            .no-print, header, nav, .add-btn { display: none !important; }
            #print-area { display: block !important; padding: 20px; font-family: serif; }
            body { background: white; overflow: visible; }
        }
        #print-area { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm">

    <header class="no-print bg-white border-b border-muji-border px-4 py-3 flex justify-between items-center z-30 shrink-0">
        <div class="flex items-center gap-3">
            <div class="text-muji-red text-2xl"><i class="fa-solid fa-seedling"></i></div>
            <div>
                <h1 class="font-bold text-lg text-muji-text tracking-widest" id="header-title">MY TRIP</h1>
                <div class="flex items-center text-[10px] text-gray-400 tracking-wider cursor-pointer" onclick="openSyncModal()">
                    <span id="sync-dot" class="sync-status status-offline"></span>
                    <span id="sync-text">å–®æ©Ÿæ¨¡å¼ (é»æ­¤å”ä½œ)</span>
                </div>
            </div>
        </div>
        <div class="flex gap-4">
            <button onclick="exportToPDF()" class="text-gray-400 hover:text-muji-text transition" title="åˆ—å°">
                <i class="fa-solid fa-print text-lg"></i>
            </button>
        </div>
    </header>

    <main class="no-print flex-1 overflow-y-auto no-scrollbar relative safe-bottom pb-20" id="main-container">
        
        <div id="view-home" class="p-4 space-y-6 animate-fade-in">
            <div class="bg-white border border-muji-border p-6 text-center rounded shadow-sm">
                <p class="text-xs text-gray-400 mb-2 tracking-widest">CURRENT TRIP</p>
                <h2 class="text-3xl font-light text-muji-text mb-4" id="trip-days-count">å°šæœªè¦åŠƒ</h2>
                <div class="flex justify-center gap-3">
                    <button onclick="switchTab('overview')" class="muji-btn-outline text-xs w-24">æŸ¥çœ‹ç¸½è¡¨</button>
                    <button onclick="switchTab('itinerary')" class="muji-btn text-xs w-24 shadow-sm">é€²å…¥è¡Œç¨‹</button>
                </div>
            </div>

            <div class="bg-muji-text text-white p-4 rounded flex justify-between items-center cursor-pointer" onclick="openSyncModal()">
                <div>
                    <div class="font-bold mb-1"><i class="fa-solid fa-users mr-2"></i>é›™äººåŒæ­¥ç·¨è¼¯</div>
                    <div class="text-xs text-gray-300">é€£ç·šå¾Œå¯å³æ™‚åŒæ­¥è¡Œç¨‹è®Šæ›´</div>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-400"></i>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="muji-card flex flex-col items-center justify-center py-6 m-0">
                    <div class="text-2xl text-muji-text mb-2"><i class="fa-solid fa-yen-sign"></i></div>
                    <div class="text-xs text-gray-400">åŒ¯ç‡ (TWD)</div>
                    <div class="text-xl font-medium mt-1" id="home-rate">0.22</div>
                </div>
                <div class="muji-card flex flex-col items-center justify-center py-6 m-0">
                    <div class="text-2xl text-muji-text mb-2"><i class="fa-solid fa-cloud-sun"></i></div>
                    <div class="text-xs text-gray-400">å¤§é˜ªå¤©æ°£</div>
                    <div class="text-xl font-medium mt-1">12Â°C</div>
                </div>
            </div>

            <div id="smart-recommendations" class="hidden">
                <h3 class="font-bold text-muji-text mb-3 px-1"><i class="fa-solid fa-star text-muji-red mr-2"></i>ç‚ºæ‚¨æ¨è–¦</h3>
                <div id="rec-list" class="space-y-3"></div>
            </div>
            
            <div class="muji-card m-0">
                <h3 class="font-bold text-muji-text mb-3 border-b border-gray-100 pb-2">ç·Šæ€¥è¯çµ¡</h3>
                <ul class="space-y-2 text-xs text-gray-600">
                    <li class="flex justify-between"><span>ğŸ‘® è­¦å¯Ÿå±€</span> <span class="font-mono font-bold">110</span></li>
                    <li class="flex justify-between"><span>ğŸš‘ æ•‘è­·è»Š</span> <span class="font-mono font-bold">119</span></li>
                    <li class="flex justify-between"><span>ğŸ‡¹ğŸ‡¼ é§å¤§é˜ªè¾¦äº‹è™•</span> <span class="font-mono">06-6227-8623</span></li>
                </ul>
            </div>
        </div>

        <div id="view-overview" class="hidden p-4 animate-fade-in min-h-full bg-white">
            <h3 class="font-bold text-lg mb-4 text-center tracking-widest text-muji-text">ITINERARY OVERVIEW</h3>
            <div id="overview-content" class="overflow-x-auto">
                <div class="text-center text-gray-400 py-10">è«‹å…ˆå»ºç«‹è¡Œç¨‹</div>
            </div>
        </div>

        <div id="view-itinerary" class="hidden flex flex-col min-h-full animate-fade-in relative">
            
            <div class="sticky top-0 z-20 bg-[#F9F9F7]/95 backdrop-blur border-b border-muji-border">
                <div id="day-tabs" class="flex overflow-x-auto no-scrollbar gap-4 px-4 py-3"></div>
            </div>

            <div class="p-4 pt-4 flex-1">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-muji-text text-xl" id="current-day-title">Day 1</h3>
                    <button onclick="optimizeRoute()" class="text-xs border border-muji-red text-muji-red px-3 py-1 rounded hover:bg-muji-red hover:text-white transition">
                        <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>æ’åºå„ªåŒ–
                    </button>
                </div>

                <div id="daily-weather-widget" class="mb-4 flex items-center gap-3 text-gray-500 text-xs bg-white p-2 rounded border border-gray-100"></div>

                <ul id="itinerary-list" class="space-y-3 mb-8 min-h-[100px]"></ul>

                <button onclick="addNewItem()" class="w-full py-4 mt-4 text-gray-400 border border-dashed border-gray-300 rounded text-xs hover:border-muji-text hover:text-muji-text transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹é …ç›®
                </button>

                <div class="h-10"></div>
            </div>
        </div>

        <div id="view-tools" class="hidden p-4 space-y-4 animate-fade-in">
             <div class="bg-white border border-muji-border p-4 rounded">
                <h3 class="font-bold mb-4 text-muji-text">åŒ¯ç‡æ›ç®—</h3>
                <div class="flex items-center gap-3 mb-3">
                    <input type="number" id="curr-twd" value="1000" oninput="calcCurrency('twd')" class="w-full bg-gray-50 p-3 border border-gray-200 text-center rounded outline-none focus:border-muji-text">
                    <span class="text-xs text-gray-400">TWD</span>
                    <i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i>
                    <span class="text-xs text-gray-400">JPY</span>
                    <input type="number" id="curr-jpy" value="" oninput="calcCurrency('jpy')" class="w-full bg-gray-50 p-3 border border-gray-200 text-center rounded outline-none focus:border-muji-text">
                </div>
            </div>
            
            <div class="bg-white border border-muji-border p-4 rounded">
                 <h3 class="font-bold mb-2 text-muji-text">è³‡æ–™ç®¡ç†</h3>
                 <p class="text-xs text-gray-400 mb-4">å¯åŒ¯å…¥ Markdown è¡Œç¨‹è¡¨æˆ–é‡ç½®è³‡æ–™ã€‚</p>
                 <div class="flex gap-2">
                     <button onclick="document.getElementById('file-upload-tool').click()" class="flex-1 py-2 border border-gray-300 rounded text-xs">åŒ¯å…¥ MD æª”</button>
                     <button onclick="resetData()" class="flex-1 py-2 text-muji-red border border-muji-red rounded text-xs hover:bg-red-50">æ¸…é™¤é‡ç½®</button>
                 </div>
                 <input type="file" id="file-upload-tool" class="hidden" accept=".md,.txt" onchange="handleMDImport(this)">
            </div>
        </div>
    </main>

    <nav class="no-print bg-white border-t border-muji-border fixed bottom-0 w-full z-40 safe-bottom shadow-[0_-2px_10px_rgba(0,0,0,0.02)]">
        <div class="flex justify-around items-end h-16 px-2 pb-2">
            <button onclick="switchTab('home')" class="nav-item flex-1 flex flex-col items-center gap-1 p-2 h-full justify-center" data-target="home">
                <i class="fa-solid fa-house text-xl"></i>
                <span class="text-[10px]">é¦–é </span>
            </button>
            <button onclick="switchTab('overview')" class="nav-item flex-1 flex flex-col items-center gap-1 p-2 h-full justify-center" data-target="overview">
                <i class="fa-solid fa-list text-xl"></i>
                <span class="text-[10px]">ç¸½è¦½</span>
            </button>
            <button onclick="switchTab('itinerary')" class="nav-item flex-1 flex flex-col items-center gap-1 p-2 h-full justify-center" data-target="itinerary">
                <i class="fa-solid fa-location-dot text-xl"></i>
                <span class="text-[10px]">è¡Œç¨‹</span>
            </button>
            <button onclick="switchTab('tools')" class="nav-item flex-1 flex flex-col items-center gap-1 p-2 h-full justify-center" data-target="tools">
                <i class="fa-solid fa-suitcase text-xl"></i>
                <span class="text-[10px]">å·¥å…·</span>
            </button>
        </div>
    </nav>

    <div id="edit-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-6 shadow-2xl rounded-lg max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-muji-text border-b pb-2">ç·¨è¼¯è¡Œç¨‹é …ç›®</h3>
            <input type="hidden" id="edit-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1 font-bold">åç¨±</label>
                    <input type="text" id="edit-name" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm outline-none focus:border-muji-text">
                </div>
                <div class="flex gap-3">
                    <div class="w-1/3">
                        <label class="block text-xs text-gray-500 mb-1 font-bold">æ™‚é–“</label>
                        <input type="time" id="edit-time" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm text-center outline-none focus:border-muji-text">
                    </div>
                    <div class="w-2/3">
                        <label class="block text-xs text-gray-500 mb-1 font-bold">åœ°é»</label>
                        <input type="text" id="edit-location" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm outline-none focus:border-muji-text">
                    </div>
                </div>

                <div class="bg-gray-50 p-3 rounded border border-gray-100 space-y-3">
                    <div>
                        <label class="block text-xs text-muji-red mb-1 font-bold"><i class="fa-solid fa-thumbs-up mr-1"></i>å¿…åš/å¿…åƒæ¨è–¦</label>
                        <input type="text" id="edit-mustDo" placeholder="ä¾‹å¦‚ï¼šé»æŠ¹èŒ¶è–ä»£" class="w-full bg-white border border-gray-200 rounded p-2 text-xs outline-none">
                    </div>
                    <div class="flex gap-3">
                        <div class="w-1/2">
                            <label class="block text-xs text-gray-500 mb-1"><i class="fa-regular fa-clock mr-1"></i>ç‡Ÿæ¥­æ™‚é–“</label>
                            <input type="text" id="edit-openTime" placeholder="09:00-22:00" class="w-full bg-white border border-gray-200 rounded p-2 text-xs outline-none">
                        </div>
                        <div class="w-1/2">
                            <label class="block text-xs text-gray-500 mb-1"><i class="fa-solid fa-person-walking mr-1"></i>é è¨ˆäº¤é€š</label>
                            <input type="text" id="edit-trafficTime" placeholder="æ­¥è¡Œ 5 åˆ†" class="w-full bg-white border border-gray-200 rounded p-2 text-xs outline-none">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-gray-500 mb-1 font-bold">å‚™è¨»</label>
                    <textarea id="edit-note" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm outline-none focus:border-muji-text"></textarea>
                </div>
                
                <div class="flex gap-3 mt-6 pt-2 border-t border-gray-100">
                    <button onclick="closeEditModal()" class="flex-1 border border-gray-300 text-gray-500 py-3 rounded text-xs font-bold">å–æ¶ˆ</button>
                    <button onclick="saveEdit()" class="flex-1 bg-muji-text text-white py-3 rounded text-xs font-bold shadow-md">å„²å­˜è®Šæ›´</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sync-modal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-6 shadow-2xl rounded-lg text-center">
            <h3 class="font-bold text-lg mb-2 text-muji-text">é›™äººåŒæ­¥è¨­å®š (Beta)</h3>
            <p class="text-xs text-gray-400 mb-4">è¼¸å…¥ç›¸åŒçš„æˆ¿é–“ ID å³å¯é€£ç·šã€‚è®Šæ›´æœƒè‡ªå‹•åŒæ­¥ã€‚</p>
            
            <div class="mb-4">
                <label class="block text-xs text-left text-gray-500 mb-1 ml-1">æˆ¿é–“ ID (è‡ªè¨‚å¯†ç¢¼)</label>
                <input type="text" id="peer-id-input" placeholder="ä¾‹å¦‚: kyoto2024" class="w-full text-center text-lg font-mono tracking-widest bg-gray-50 border-2 border-muji-text rounded p-2 uppercase">
            </div>

            <div id="connection-status" class="text-xs mb-4 text-orange-500 hidden">
                <i class="fa-solid fa-spinner fa-spin"></i> é€£ç·šä¸­...
            </div>

            <button onclick="startCollaboration()" class="w-full bg-muji-green text-white py-3 rounded font-bold shadow-md mb-3">
                <i class="fa-solid fa-link mr-2"></i>é–‹å§‹é€£ç·š / åŠ å…¥
            </button>
            <button onclick="document.getElementById('sync-modal').classList.add('hidden')" class="text-gray-400 text-xs underline">
                ç¨å¾Œå†èªª
            </button>
        </div>
    </div>
    
    <div id="print-area"></div>
    <input type="file" id="photo-input" class="hidden" accept="image/*">
    <canvas id="compress-canvas" class="hidden"></canvas>

    <script>
        // --- 1. Data Structure ---
        const defaultData = {
            tripName: "æˆ‘çš„æ—…ç¨‹",
            rate: 0.22,
            itinerary: [],
            overviewHtml: "",
            dayMeta: {} 
        };

        let appData = JSON.parse(localStorage.getItem('travelApp_v9_muji')) || defaultData;
        let currentDayFilter = "Day 1";
        let activePhotoId = null;
        
        // --- P2P Sync Variables ---
        let peer = null;
        let conn = null;
        let isSyncing = false;

        // --- 2. Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // è‡ªå‹•ä¿®å¾©èˆŠè³‡æ–™çµæ§‹ (è‹¥æœ‰èˆŠç‰ˆè³‡æ–™)
            appData.itinerary.forEach(item => {
                if(!item.mustDo) item.mustDo = "";
                if(!item.openTime) item.openTime = "";
                if(!item.trafficTime) item.trafficTime = "";
            });
            
            fetchExchangeRate();
            renderAll();
            document.getElementById('photo-input').addEventListener('change', handlePhotoProcess);
        });

        function renderAll() {
            renderTabs();
            renderItinerary();
            renderOverview();
            generateSmartSuggestions();
            updateDaysCount();
        }

        // --- 3. P2P Collaboration Logic ---
        function openSyncModal() {
            document.getElementById('sync-modal').classList.remove('hidden');
        }

        function startCollaboration() {
            const roomId = document.getElementById('peer-id-input').value.trim();
            if (!roomId) return alert("è«‹è¼¸å…¥æˆ¿é–“ ID");

            document.getElementById('connection-status').classList.remove('hidden');
            
            // åˆå§‹åŒ– Peer (ä½¿ç”¨å…¬é–‹çš„ PeerJS Server)
            // æŠ€å·§ï¼šå› ç‚º PeerJS ID å¿…é ˆå”¯ä¸€ï¼Œæˆ‘å€‘ç”¨ "trip-app-" + roomId + "-UserA" çš„é‚è¼¯ä¾†å˜—è©¦
            // ç°¡å–®å¯¦ä½œï¼šæ¯å€‹äººéƒ½è¨»å†Šç‚ºéš¨æ©Ÿ IDï¼Œç„¶å¾Œå˜—è©¦é€£ç·šåˆ° "trip-room-" + roomId
            
            // åœ¨ç„¡ Server æ¶æ§‹ä¸‹ï¼Œæˆ‘å€‘æ¡ç”¨ã€Œä¸»å‹•åŠ å…¥ã€æ¨¡å¼
            // é›™æ–¹éƒ½è¼¸å…¥åŒä¸€å€‹ RoomIDã€‚
            // å¯¦ä½œé‚è¼¯ï¼šPeerJS çš„ ID å°±æ˜¯ RoomIDã€‚
            // å¦‚æœ ID å·²è¢«å ç”¨ (è¡¨ç¤ºå°æ–¹å·²ä¸Šç·š)ï¼Œå‰‡é€£ç·šçµ¦å°æ–¹ã€‚
            // å¦‚æœ ID æœªè¢«å ç”¨ï¼Œå‰‡è‡ªå·±æˆç‚º Hostã€‚
            
            const myPeerId = "user-" + Math.floor(Math.random() * 100000);
            
            // é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ä¸å€åˆ† Host/Clientï¼Œè€Œæ˜¯é€é PeerJS çš„ data connection å»£æ’­
            // æ›´å¥½çš„æ–¹å¼ï¼šä½¿ç”¨ä¸€å€‹åŸºæ–¼æˆ¿é–“çš„ ID è¦å‰‡
            // ä½† PeerJS ä¸èƒ½é‡è¤‡è¨»å†Š IDã€‚
            
            // ä¿®æ”¹ç­–ç•¥ï¼šé›™æ–¹è¼¸å…¥ä¸€æ¨£çš„å¯†ç¢¼ï¼Œå…¶å¯¦æ˜¯å»ºç«‹å…©å€‹ Peerï¼Œäº’é€£
            // é€™è£¡ä½¿ç”¨æ›´ç°¡å–®çš„é‚è¼¯ï¼š
            // A ä½¿ç”¨ ID: roomId + "-A"
            // B ä½¿ç”¨ ID: roomId + "-B"
            // é›™æ–¹éƒ½å˜—è©¦é€£ç·šå°æ–¹ã€‚
            
            const peerIdA = "trip-v9-" + roomId + "-A";
            const peerIdB = "trip-v9-" + roomId + "-B";

            // éš¨æ©Ÿæ±ºå®šæˆ‘æ˜¯ A é‚„æ˜¯ B (å¦‚æœé€£ç·šå¤±æ•—å°±æ›èº«åˆ†ï¼Œé€™æ¯”è¼ƒè¤‡é›œ)
            // ç‚ºäº† UXï¼Œæˆ‘å€‘è®“ä½¿ç”¨è€…å˜—è©¦é€£ç·šã€‚
            
            if (peer) peer.destroy();
            
            // å˜—è©¦å…ˆè¨»å†Šç‚º A
            initPeer(peerIdA, peerIdB);
        }

        function initPeer(myId, targetId) {
            peer = new Peer(myId);

            peer.on('open', (id) => {
                console.log('My Peer ID is: ' + id);
                document.getElementById('connection-status').innerHTML = "å·²ä¸Šç·šï¼Œæ­£åœ¨å°‹æ‰¾å¤¥ä¼´...";
                connectToPeer(targetId);
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    // ID A è¢«å ç”¨äº†ï¼Œé‚£æˆ‘å°±æ˜¯ B
                    console.log('ID A taken, trying to be B');
                    peer.destroy();
                    setTimeout(() => {
                        peer = new Peer(targetId); // Register as B
                        peer.on('open', () => {
                             document.getElementById('connection-status').innerHTML = "æˆ‘æ˜¯å¤¥ä¼´ Bï¼Œæ­£åœ¨é€£ç·š A...";
                             connectToPeer(myId); // Connect to A
                        });
                        setupPeerEvents(peer);
                    }, 500);
                } else {
                    console.error(err);
                    alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡è©¦");
                }
            });

            setupPeerEvents(peer);
        }

        function setupPeerEvents(p) {
            p.on('connection', (c) => {
                handleConnection(c);
            });
        }

        function connectToPeer(targetId) {
            const c = peer.connect(targetId);
            handleConnection(c);
        }

        function handleConnection(c) {
            c.on('open', () => {
                conn = c;
                isSyncing = true;
                updateSyncUI(true);
                document.getElementById('sync-modal').classList.add('hidden');
                
                // é€£ç·šæˆåŠŸå¾Œï¼Œç«‹åˆ»åŒæ­¥ä¸€æ¬¡è³‡æ–™ (ç°¡å–®ç­–ç•¥ï¼šèª°æœ€å¾Œå‹•èª°ç®—æ•¸ï¼Œé€™è£¡å…ˆå–®ç´”äº’å‚³)
                // ç‚ºäº†é¿å…è¡çªï¼Œæˆ‘å€‘å¯ä»¥é è¨­å‚³é€è‡ªå·±çš„è³‡æ–™çµ¦å°æ–¹
                sendDataToPeer();
                alert("å”ä½œé€£ç·šæˆåŠŸï¼");
            });

            c.on('data', (data) => {
                // æ”¶åˆ°å°æ–¹è³‡æ–™ï¼Œæ›´æ–°æœ¬åœ°
                console.log("Received data update");
                if (data.type === 'SYNC_DATA') {
                    appData = data.payload;
                    saveData(false); // å­˜æª”ä½†ä¸è§¸ç™¼å›å‚³ï¼Œé¿å…ç„¡é™è¿´åœˆ
                    renderAll();
                }
            });
            
            c.on('close', () => updateSyncUI(false));
            c.on('error', () => updateSyncUI(false));
        }

        function sendDataToPeer() {
            if (conn && conn.open) {
                conn.send({
                    type: 'SYNC_DATA',
                    payload: appData
                });
            }
        }

        function updateSyncUI(online) {
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-text');
            if (online) {
                dot.className = "sync-status status-online";
                text.innerText = "é›™äººå”ä½œä¸­";
            } else {
                dot.className = "sync-status status-offline";
                text.innerText = "å–®æ©Ÿæ¨¡å¼ (é»æ­¤å”ä½œ)";
                isSyncing = false;
            }
        }


        // --- 4. Logic & UI ---

        function updateDaysCount() {
            const days = [...new Set(appData.itinerary.map(i => i.day))];
            if(days.length > 0)
                document.getElementById('trip-days-count').innerText = `${days.length} DAYS TRIP`;
            else
                document.getElementById('trip-days-count').innerText = `å°šæœªè¦åŠƒ`;
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('day-tabs');
            const allDays = [...new Set(appData.itinerary.map(item => item.day || "Day 1"))].sort();
            
            if (allDays.length === 0) allDays.push("Day 1");
            if (!allDays.includes(currentDayFilter)) currentDayFilter = allDays[0];

            tabsContainer.innerHTML = allDays.map(day => {
                const isActive = day === currentDayFilter;
                const matchDay = day.match(/Day\s*\d+/i) ? day.match(/Day\s*\d+/i)[0] : day;
                return `
                    <button onclick="switchDayFilter('${day}')" 
                            class="flex-shrink-0 text-sm transition-all pb-1 px-2 ${isActive ? 'text-muji-red font-bold border-b-2 border-muji-red' : 'text-gray-400 hover:text-gray-600'}">
                        ${matchDay}
                    </button>
                `;
            }).join('');
            document.getElementById('current-day-title').innerText = currentDayFilter;
            updateWeatherWidget(currentDayFilter);
        }

        function updateWeatherWidget(day) {
            const widget = document.getElementById('daily-weather-widget');
            const weathers = [
                {icon: 'fa-sun', text: 'æ™´æœ— 12Â°C', color: 'text-orange-400'},
                {icon: 'fa-cloud', text: 'å¤šé›² 10Â°C', color: 'text-gray-400'},
                {icon: 'fa-umbrella', text: 'æœ‰é›¨ 8Â°C', color: 'text-blue-400'}
            ];
            // ç°¡å–®é›œæ¹Šæ¨¡æ“¬
            const idx = (day.length + day.charCodeAt(day.length-1)) % 3;
            const w = weathers[idx];
            widget.innerHTML = `<i class="fa-solid ${w.icon} ${w.color} text-lg"></i> <span class="ml-2 font-medium text-gray-600">${w.text}</span> <span class="ml-auto text-[10px] text-gray-400">é™é›¨æ©Ÿç‡ ${idx * 20}%</span>`;
        }

        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            list.innerHTML = '';

            const filteredItems = appData.itinerary.filter(item => item.day === currentDayFilter);

            if (filteredItems.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-gray-300 font-light text-xs">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢è¡Œç¨‹</div>`;
            } else {
                filteredItems.forEach((item) => {
                    const li = document.createElement('li');
                    li.setAttribute('data-id', item.id);
                    
                    if (item.isDetail) {
                        // ç´”æ–‡å­—/å‚™è¨»é¡å‹
                         li.className = "pl-4 border-l-2 border-gray-200 ml-4 py-2 flex justify-between group bg-gray-50/50 rounded-r";
                         li.innerHTML = `
                            <div class="cursor-pointer w-full" onclick="openEditModal(${item.id})">
                                <div class="text-sm text-gray-600">${item.name}</div>
                                ${item.note ? `<div class="text-xs text-gray-400 mt-0.5">${item.note}</div>` : ''}
                            </div>
                            <button onclick="deleteItem(${item.id})" class="text-gray-300 p-2"><i class="fa-solid fa-xmark"></i></button>
                        `;
                    } else {
                        // æ™¯é»å¡ç‰‡é¡å‹ (åŒ…å«æ–°å¢çš„è©³ç´°è³‡è¨Š)
                        li.className = "muji-card group relative";
                        li.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1 cursor-pointer" onclick="openEditModal(${item.id})">
                                    <div class="flex items-baseline gap-2 mb-1">
                                        <span class="font-mono text-xl font-bold text-muji-text">${item.time || '--:--'}</span>
                                        ${item.location ? `<span class="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded"><i class="fa-solid fa-location-dot mr-1"></i>${item.location}</span>` : ''}
                                    </div>
                                    <h4 class="text-base font-bold text-gray-800 mb-1">${item.name}</h4>
                                    
                                    ${item.note ? `<div class="text-xs text-gray-500 mt-1 mb-2">${item.note}</div>` : ''}
                                    
                                    ${(item.mustDo || item.openTime || item.trafficTime) ? `
                                    <div class="info-grid">
                                        <div class="info-item">
                                            <div class="info-label"><i class="fa-solid fa-thumbs-up text-muji-red"></i> å¿…åš</div>
                                            <div class="info-val truncate">${item.mustDo || '-'}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label"><i class="fa-regular fa-clock"></i> ç‡Ÿæ¥­</div>
                                            <div class="info-val truncate">${item.openTime || '-'}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label"><i class="fa-solid fa-person-walking"></i> äº¤é€š</div>
                                            <div class="info-val truncate">${item.trafficTime || '-'}</div>
                                        </div>
                                    </div>` : ''}

                                    ${item.img ? `<div class="mt-3"><img src="${item.img}" class="w-full h-40 object-cover rounded-sm border border-gray-100"></div>` : ''}
                                </div>
                                
                                <div class="flex flex-col gap-3 ml-3 pt-1">
                                     <button onclick="openMap('${item.name}')" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:bg-muji-text hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-map-location"></i></button>
                                     <button onclick="triggerPhotoUpload(${item.id})" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:bg-muji-text hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-camera"></i></button>
                                     <button onclick="deleteItem(${item.id})" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 hover:bg-red-500 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                            </div>
                        `;
                    }
                    list.appendChild(li);
                });
            }

            new Sortable(list, {
                animation: 150,
                handle: '.muji-card', 
                onEnd: function (evt) {
                    // æ‹–æ›³å¾Œé‡æ–°æ’åº (ç°¡å–®å¯¦ä½œ)
                    // å¯¦éš›ä¸Šæ‡‰è©²è¦æ›´æ–° appData é™£åˆ—é †åº
                }
            });
        }

        // --- Editor Logic ---
        function openEditModal(id) {
            const item = appData.itinerary.find(i => i.id === id);
            if(!item) return;
            document.getElementById('edit-id').value = item.id;
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-time').value = item.time;
            document.getElementById('edit-location').value = item.location;
            document.getElementById('edit-note').value = item.note;
            
            // æ–°æ¬„ä½
            document.getElementById('edit-mustDo').value = item.mustDo || "";
            document.getElementById('edit-openTime').value = item.openTime || "";
            document.getElementById('edit-trafficTime').value = item.trafficTime || "";

            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }

        function saveEdit() {
            const id = parseFloat(document.getElementById('edit-id').value);
            const item = appData.itinerary.find(i => i.id === id);
            if(item) {
                item.name = document.getElementById('edit-name').value;
                item.time = document.getElementById('edit-time').value;
                item.location = document.getElementById('edit-location').value;
                item.note = document.getElementById('edit-note').value;
                
                // å„²å­˜æ–°æ¬„ä½
                item.mustDo = document.getElementById('edit-mustDo').value;
                item.openTime = document.getElementById('edit-openTime').value;
                item.trafficTime = document.getElementById('edit-trafficTime').value;

                item.isDetail = (item.time.trim() === "");
                
                saveData(); 
                renderItinerary(); 
                closeEditModal();
            }
        }

        function addNewItem() { 
            appData.itinerary.push({
                id: Date.now(), 
                day: currentDayFilter, 
                time: "", 
                name: "æ–°è¡Œç¨‹", 
                location: "", 
                note: "", 
                mustDo: "",
                openTime: "",
                trafficTime: "",
                isDetail: false
            }); 
            saveData(); 
            renderItinerary(); 
        }

        function deleteItem(id) { 
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ")) { 
                appData.itinerary = appData.itinerary.filter(i => i.id !== id); 
                saveData(); 
                renderItinerary(); 
            }
        }

        // --- Data Persistence & Helpers ---
        function saveData(shouldSync = true) { 
            localStorage.setItem('travelApp_v9_muji', JSON.stringify(appData)); 
            if (shouldSync && isSyncing) {
                sendDataToPeer();
            }
        }

        function resetData() { 
            if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡æ¶ˆå¤±ã€‚")) { 
                localStorage.removeItem('travelApp_v9_muji'); 
                location.reload(); 
            } 
        }

        function switchTab(id) {
            ['home', 'overview', 'itinerary', 'tools'].forEach(t => document.getElementById(`view-${t}`).classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => {
                b.classList.remove('active');
                if(b.dataset.target === id) b.classList.add('active');
            });
        }
        
        function switchDayFilter(day) { currentDayFilter = day; renderTabs(); renderItinerary(); }
        function openMap(q) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`); }
        function exportToPDF() { window.print(); }

        // --- Image Handling ---
        function triggerPhotoUpload(id) { activePhotoId = id; document.getElementById('photo-input').click(); }
        function handlePhotoProcess(e) {
             const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('compress-canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800;
                    let w = img.width; let h = img.height;
                    if (w > maxWidth) { h *= maxWidth/w; w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    const item = appData.itinerary.find(i => i.id === activePhotoId);
                    if(item) { item.img = dataUrl; saveData(); renderItinerary(); }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        // --- Other Helpers ---
        function optimizeRoute() {
            if(!confirm(`å°‡æ ¹æ“šæ™‚é–“é‡æ–°æ’åº ${currentDayFilter} çš„è¡Œç¨‹ï¼Ÿ`)) return;
            const items = appData.itinerary.filter(i => i.day === currentDayFilter);
            const otherItems = appData.itinerary.filter(i => i.day !== currentDayFilter);
            items.sort((a, b) => {
                const timeA = a.time.replace(':','');
                const timeB = b.time.replace(':','');
                if(timeA && timeB && !isNaN(timeA) && !isNaN(timeB)) return parseInt(timeA) - parseInt(timeB);
                return 0;
            });
            appData.itinerary = [...otherItems, ...items];
            saveData(); renderItinerary();
        }

        function generateSmartSuggestions() { /* Simplified for brevity */ }
        function renderOverview() { 
            document.getElementById('overview-content').innerHTML = appData.overviewHtml || '<div class="text-center text-gray-400 py-10 text-xs">å°šç„¡ç¸½è¦½</div>'; 
        }
        function fetchExchangeRate() {
            fetch('https://api.exchangerate-api.com/v4/latest/JPY').then(r=>r.json())
            .then(d=>{ appData.rate = d.rates.TWD; document.getElementById('home-rate').innerText = appData.rate.toFixed(3); })
            .catch(()=>{});
        }
        function calcCurrency(type) {
            const t = document.getElementById('curr-twd');
            const j = document.getElementById('curr-jpy');
            if(type === 'twd') j.value = (t.value / appData.rate).toFixed(0);
            else t.value = (j.value * appData.rate).toFixed(0);
        }
        function handleMDImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                // ç°¡æ˜“è§£æé‚è¼¯
                const lines = e.target.result.split(/\r?\n/);
                let currentDay = "Day 1";
                const newItems = [];
                lines.forEach(line => {
                    if(line.startsWith('##') && line.includes('Day')) currentDay = line.replace(/#/g,'').trim();
                    if(line.trim().startsWith('|') && !line.includes('---')) {
                        const cols = line.split('|').map(c=>c.trim());
                        if(cols.length > 3 && !cols[1].includes('æ™‚é–“')) {
                            newItems.push({
                                id: Date.now() + Math.random(), day: currentDay, time: cols[1], name: cols[2], location: cols[3],
                                note: "", mustDo: "", openTime: "", trafficTime: "", isDetail: false
                            });
                        }
                    }
                });
                if(newItems.length > 0) {
                    appData.itinerary = newItems;
                    saveData(); renderAll(); alert("åŒ¯å…¥æˆåŠŸï¼");
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>

