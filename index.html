<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…äººãƒ»éš¨èº«è¦åŠƒ (v8 å®¢è£½ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0EA5E9', 
                        secondary: '#64748B',
                        accent: '#F59E0B',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* æ‰‹æ©Ÿé«”é©—å„ªåŒ– */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        body { -webkit-tap-highlight-color: transparent; }
        
        /* === æ™ºæ…§æ¨™ç±¤æ¨£å¼ === */
        .tag-eat { color: #9f1239; background-color: #ffe4e6; font-weight: 800; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; border: 1px solid #fda4af; }
        .tag-menu { color: #b45309; background-color: #fffbeb; font-weight: 800; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; border-bottom: 2px solid #f59e0b; }
        .tag-buy { color: #15803d; background-color: #dcfce7; font-weight: 800; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; border: 1px solid #86efac; }
        .tag-res { color: #ffffff; background-color: #7c3aed; font-weight: 800; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; box-shadow: 2px 2px 0px #5b21b6; }
        .tag-imp { color: #1e40af; background-color: #dbeafe; font-weight: 800; padding: 0 4px; text-decoration: underline; text-underline-offset: 4px; text-decoration-color: #3b82f6; }

        /* ä¸€èˆ¬è¡¨æ ¼æ¨£å¼ (ç”¨æ–¼åº•éƒ¨è³‡è¨Š) */
        .info-block table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.5); }
        .info-block th { background: rgba(0,0,0,0.05); padding: 8px; text-align: left; border: 1px solid rgba(0,0,0,0.1); font-weight: bold; color: #374151; }
        .info-block td { padding: 8px; border: 1px solid rgba(0,0,0,0.1); vertical-align: top; }
        .info-block ul { list-style-type: disc; padding-left: 20px; margin: 5px 0; }
        .info-block a { color: #0EA5E9; text-decoration: underline; }

        /* é¦–é ç¸½è¦½è¡¨æ ¼æ¨£å¼ */
        .overview-table-container table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; }
        .overview-table-container th { background-color: #f1f5f9; color: #334155; font-weight: bold; padding: 10px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .overview-table-container td { padding: 10px; border-bottom: 1px solid #f1f5f9; color: #475569; }
        .overview-table-container tr:last-child td { border-bottom: none; }

        /* AI åˆ†æå€å¡Šæ¨£å¼ */
        .ai-box { background: linear-gradient(to right, #eff6ff, #ffffff); border-left: 4px solid #3b82f6; padding: 8px 12px; margin-top: 10px; border-radius: 0 8px 8px 0; font-size: 0.8rem; color: #1e3a8a; display: flex; align-items: start; gap: 8px; }

        /* åˆ—å°æ¨£å¼ */
        @media print {
            .no-print, header, nav, .drag-handle, .add-btn, button, input[type="file"], .photo-btn { display: none !important; }
            #print-area { display: block !important; padding: 20px; font-family: serif; }
            body { background: white; height: auto; overflow: visible; }
            .print-break { page-break-before: always; }
            #view-itinerary { display: none; }
        }
        #print-area { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <header class="no-print bg-white shadow-sm px-4 py-3 flex justify-between items-center z-30 shrink-0 relative">
        <div class="flex items-center gap-2">
            <div class="bg-gradient-to-tr from-primary to-blue-400 text-white rounded-lg w-9 h-9 flex items-center justify-center shadow-lg shadow-blue-200">
                <i class="fa-solid fa-plane-departure"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight" id="header-title">æˆ‘çš„æ—…ç¨‹</h1>
                <p class="text-[10px] text-gray-400">v8 å®¢è£½ç‰ˆ</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="document.getElementById('file-upload-header').click()" class="text-gray-500 hover:text-primary p-2 rounded-full active:bg-gray-100" title="åŒ¯å…¥è¡Œç¨‹">
                <i class="fa-solid fa-file-import"></i>
            </button>
        </div>
        <input type="file" id="file-upload-header" class="hidden" accept=".md,.txt" onchange="handleMDImport(this)">
    </header>

    <main class="no-print flex-1 overflow-y-auto no-scrollbar relative safe-bottom pb-24" id="main-container">
        
        <div id="view-home" class="p-4 space-y-6 animate-fade-in">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-6 text-white shadow-xl shadow-blue-200 relative overflow-hidden">
                <div class="absolute right-[-10px] top-[-10px] opacity-20 transform rotate-12">
                    <i class="fa-solid fa-earth-asia text-9xl"></i>
                </div>
                <div class="relative z-10">
                    <p class="text-blue-100 text-sm mb-1"><i class="fa-solid fa-calendar-days mr-1"></i>æ—…ç¨‹ç‹€æ…‹</p>
                    <h2 class="text-3xl font-bold mb-3 tracking-wide" id="trip-days-count">è¦åŠƒä¸­</h2>
                    <div class="flex gap-2">
                         <button onclick="switchTab('itinerary')" class="bg-white/20 hover:bg-white/30 backdrop-blur-md px-4 py-2 rounded-lg text-sm transition">
                            <i class="fa-solid fa-list-check mr-1"></i> æŸ¥çœ‹è¡Œç¨‹
                        </button>
                        <button onclick="switchTab('tools')" class="bg-white text-blue-600 px-4 py-2 rounded-lg text-sm font-bold shadow-sm active:scale-95 transition">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> å·¥å…·ç®±
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden group" onclick="switchTab('tools')">
                    <div class="absolute right-2 top-2 text-green-100 text-5xl group-hover:scale-110 transition"><i class="fa-solid fa-money-bill-wave"></i></div>
                    <p class="text-xs text-gray-500 mb-1">åŒ¯ç‡ (JPY)</p>
                    <h3 class="text-2xl font-bold text-gray-800 font-mono" id="home-rate">...</h3>
                    <p class="text-[10px] text-green-500 mt-1"><i class="fa-solid fa-rotate mr-1"></i>å³æ™‚æ›´æ–°</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden group">
                     <div class="absolute right-2 top-2 text-yellow-100 text-5xl group-hover:scale-110 transition"><i class="fa-solid fa-sun"></i></div>
                    <p class="text-xs text-gray-500 mb-1">ç›®çš„åœ°å¤©æ°£</p>
                    <h3 class="text-2xl font-bold text-gray-800 font-mono">12Â°C</h3>
                    <p class="text-[10px] text-orange-500 mt-1">æ™´æ™‚å¤šé›²</p>
                </div>
            </div>
            
            <div id="overview-section" class="hidden">
                 <h3 class="font-bold text-gray-700 text-lg mb-2 pl-1 border-l-4 border-primary">è¡Œç¨‹ç¸½è¦½</h3>
                 <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden overflow-x-auto overview-table-container p-2" id="overview-content">
                     </div>
            </div>
        </div>

        <div id="view-itinerary" class="hidden flex flex-col min-h-full animate-fade-in relative">
            
            <div class="sticky top-0 z-20 bg-gray-50/95 backdrop-blur border-b border-gray-200">
                <div id="day-tabs" class="flex overflow-x-auto no-scrollbar gap-2 px-4 py-3">
                    </div>
            </div>

            <div class="p-4 pt-4 flex-1">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="font-bold text-gray-700 text-lg" id="current-day-title">Day 1</h3>
                    <span class="text-xs text-gray-400 bg-gray-200 px-2 py-1 rounded-full"><i class="fa-solid fa-arrows-up-down mr-1"></i>é•·æŒ‰æ‹–æ›³</span>
                </div>

                <ul id="itinerary-list" class="space-y-4 mb-8 min-h-[100px]">
                    </ul>

                <div id="bottom-summary-section" class="hidden animate-fade-in">
                    <div class="border-t-2 border-dashed border-gray-200 my-6 relative">
                        <span class="absolute top-[-12px] left-1/2 transform -translate-x-1/2 bg-gray-50 px-3 text-xs text-gray-400 font-bold tracking-wider"> ç•¶æ—¥è³‡è¨Šå½™æ•´ </span>
                    </div>
                    <div id="day-summary-container" class="space-y-4 pb-4"></div>
                </div>

                <button onclick="addNewItem()" class="w-full py-4 mt-4 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl flex items-center justify-center gap-2 hover:bg-white hover:border-primary hover:text-primary transition active:scale-95">
                    <i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹
                </button>
            </div>
        </div>

        <div id="view-notepad" class="hidden p-4 animate-fade-in h-full flex flex-col">
            <div class="bg-yellow-100 rounded-xl p-4 text-yellow-800 mb-4 shadow-sm border border-yellow-200">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-pen-to-square mr-2"></i>éš¨æ‰‹ç­†è¨˜</h3>
                <p class="text-xs text-yellow-700 mt-1">æ­¤è™•çš„å…§å®¹æœƒè‡ªå‹•å„²å­˜ï¼Œå¯è¨˜éŒ„è‡¨æ™‚æƒ³æ³•æˆ–å‚™å¿˜ã€‚</p>
            </div>
            <textarea id="notepad-area" class="flex-1 w-full bg-white border border-gray-200 rounded-xl p-4 shadow-sm focus:ring-2 focus:ring-primary focus:outline-none text-gray-700 leading-relaxed" placeholder="åœ¨é€™è£¡è¼¸å…¥æ‚¨çš„ç­†è¨˜..."></textarea>
        </div>

        <div id="view-tools" class="hidden p-4 space-y-4 animate-fade-in">
            <label class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-5 rounded-2xl shadow-lg flex items-center justify-center gap-4 hover:shadow-xl transition cursor-pointer active:scale-95">
                <div class="bg-white/20 p-3 rounded-full"><i class="fa-solid fa-file-import text-2xl"></i></div>
                <div class="text-left flex-1">
                    <div class="font-bold text-lg">åŒ¯å…¥ Markdown è¡Œç¨‹</div>
                    <div class="text-xs text-blue-100">æ”¯æ´è¡¨æ ¼ã€è‡ªè²»èˆ‡è½‰ä¹˜å»ºè­°æ ¼å¼</div>
                </div>
                <input type="file" id="md-import-tools" class="hidden" accept=".md,.txt,.markdown" onchange="handleMDImport(this)">
            </label>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold mb-4 flex items-center gap-2 text-gray-700"><i class="fa-solid fa-coins text-yellow-500"></i> å³æ™‚åŒ¯ç‡æ›ç®—</h3>
                <div class="flex items-center gap-3 mb-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">TWD (å°å¹£)</label>
                        <input type="number" id="curr-twd" value="1000" oninput="calcCurrency('twd')" class="w-full bg-gray-50 p-3 rounded-xl font-mono text-xl outline-none focus:ring-2 focus:ring-primary transition text-center">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i>
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">JPY (æ—¥åœ“)</label>
                        <input type="number" id="curr-jpy" value="" oninput="calcCurrency('jpy')" class="w-full bg-gray-50 p-3 rounded-xl font-mono text-xl outline-none focus:ring-2 focus:ring-primary transition text-center">
                    </div>
                </div>
                <div class="text-center text-xs text-gray-400" id="rate-display">è¼‰å…¥ä¸­...</div>
            </div>

            <button onclick="exportToPDF()" class="w-full bg-gray-800 text-white p-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition">
                <i class="fa-solid fa-print text-xl"></i>
                <div class="text-left flex-1">
                    <div class="font-bold">åŒ¯å‡ºè¡Œç¨‹å–® (PDF)</div>
                    <div class="text-xs text-gray-400">å«è©³ç´°å‚™è¨»èˆ‡è½‰ä¹˜è³‡è¨Š</div>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-500"></i>
            </button>
             <button onclick="resetData()" class="w-full py-3 text-red-400 text-sm border border-red-100 rounded-lg hover:bg-red-50">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
    </main>

    <nav class="no-print bg-white border-t border-gray-200 fixed bottom-0 w-full z-40 safe-bottom shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around items-center h-16 px-2">
            <button onclick="switchTab('home')" class="nav-btn active flex-1 group" data-target="home">
                <div class="flex flex-col items-center gap-1 text-gray-400 group-hover:text-primary transition duration-300">
                    <div class="text-xl relative"><i class="fa-solid fa-house"></i></div>
                    <span class="text-[10px] font-medium">ç¸½è¦½</span>
                </div>
            </button>
            <button onclick="switchTab('itinerary')" class="nav-btn flex-1 group" data-target="itinerary">
                <div class="flex flex-col items-center gap-1 text-gray-400 group-hover:text-primary transition duration-300">
                    <div class="text-xl relative"><i class="fa-solid fa-map-location-dot"></i></div>
                    <span class="text-[10px] font-medium">è¡Œç¨‹</span>
                </div>
            </button>
            <button onclick="switchTab('notepad')" class="nav-btn flex-1 group" data-target="notepad">
                <div class="flex flex-col items-center gap-1 text-gray-400 group-hover:text-primary transition duration-300">
                    <div class="text-xl relative">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </div>
                    <span class="text-[10px] font-medium">è¨˜äº‹</span>
                </div>
            </button>
            <button onclick="switchTab('tools')" class="nav-btn flex-1 group" data-target="tools">
                <div class="flex flex-col items-center gap-1 text-gray-400 group-hover:text-primary transition duration-300">
                    <div class="text-xl relative"><i class="fa-solid fa-suitcase"></i></div>
                    <span class="text-[10px] font-medium">å·¥å…·</span>
                </div>
            </button>
        </div>
    </nav>

    <canvas id="compress-canvas" class="hidden"></canvas>
    <input type="file" id="photo-input" class="hidden" accept="image/*" capture="environment">

    <div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">ç·¨è¼¯è¡Œç¨‹</h3>
            <div class="space-y-3">
                <input type="hidden" id="edit-id">
                <div><label class="text-xs text-gray-500">åç¨±</label><input type="text" id="edit-name" class="w-full border rounded-lg p-2 outline-none focus:ring-2 focus:ring-primary"></div>
                <div class="flex gap-2">
                    <div class="w-1/3"><label class="text-xs text-gray-500">æ™‚é–“</label><input type="text" id="edit-time" class="w-full border rounded-lg p-2 text-center"></div>
                    <div class="w-2/3"><label class="text-xs text-gray-500">åœ°é»</label><input type="text" id="edit-location" class="w-full border rounded-lg p-2"></div>
                </div>
                <div><label class="text-xs text-gray-500">å‚™è¨»</label><textarea id="edit-note" rows="3" class="w-full border rounded-lg p-2 text-sm"></textarea></div>
                <div class="flex gap-2 mt-4">
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg">å–æ¶ˆ</button>
                    <button onclick="saveEdit()" class="flex-1 bg-primary text-white py-2 rounded-lg font-bold shadow-md">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-area"></div>

    <script>
        // --- 1. Data & State ---
        const defaultData = {
            tripName: "æˆ‘çš„æ—…ç¨‹",
            rate: 0.22,
            itinerary: [],
            dayMeta: {},
            overviewMarkdown: "", // å„²å­˜ Day 1 ä¹‹å‰çš„ç¸½è¦½è¡¨æ ¼ Markdown
            notepadContent: ""    // è¨˜äº‹æœ¬å…§å®¹
        };

        let appData = JSON.parse(localStorage.getItem('travelApp_v8')) || defaultData;
        let currentDayFilter = "Day 1";
        let activePhotoId = null;

        // --- 2. Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchExchangeRate();
            renderTabs();
            renderItinerary();
            renderOverview();
            initNotepad();
            initSortable();

            document.getElementById('photo-input').addEventListener('change', handlePhotoProcess);
        });

        // --- 3. Markdown Parsing (å®¢è£½åŒ–é‚è¼¯) ---
        function parseMD(text) {
            const lines = text.split(/\r?\n/);
            const newItems = [];
            const newDayMeta = {};
            let newOverviewMD = "";
            
            let parsingDay = null; // é–‹å§‹ç‚º nullï¼Œä»£è¡¨æ­£åœ¨è§£æç¸½è¦½å€å¡Š
            let parseMode = "SCHEDULE"; // SCHEDULE, TRANSFER, FOOD, COST, TIPS, BACKUP, OTHER
            
            lines.forEach(line => {
                let trimmed = line.trim();

                // 1. åµæ¸¬æ—¥æœŸåˆ‡æ› (# Day X)
                if ((trimmed.startsWith('#') || trimmed.startsWith('##')) && trimmed.match(/Day/i)) {
                    // æ’é™¤ "Day X æ™šé¤" é€™ç¨®å­æ¨™é¡Œ
                    if (trimmed.includes('æ™šé¤') || trimmed.includes('æ¨è–¦')) {
                        // é€™æ˜¯å­æ¨™é¡Œï¼Œä¸åˆ‡æ›æ—¥æœŸ
                    } else {
                        parsingDay = trimmed.replace(/#+\s*/, '').trim(); 
                        parseMode = "SCHEDULE"; // é‡ç½®æ¨¡å¼
                        if (!newDayMeta[parsingDay]) newDayMeta[parsingDay] = { cost: "", transfer: "", food: "", tips: "", backup: "" };
                        return;
                    }
                }

                // **ç¸½è¦½å€å¡Šè§£æ**ï¼šå¦‚æœåœ¨é‡åˆ°ç¬¬ä¸€å€‹ Day ä¹‹å‰
                if (!parsingDay) {
                    newOverviewMD += line + "\n";
                    return;
                }

                // ç¢ºä¿ meta å­˜åœ¨
                if (!newDayMeta[parsingDay]) newDayMeta[parsingDay] = { cost: "", transfer: "", food: "", tips: "", backup: "" };

                // 2. åµæ¸¬å€å¡Šæ¨™é¡Œ (åˆ‡æ›æ¨¡å¼)
                if (trimmed.startsWith('###') || (trimmed.startsWith('**') && trimmed.includes('å‚™æ¡ˆ'))) {
                    const lower = trimmed.toLowerCase();
                    if (lower.includes('è½‰ä¹˜') || lower.includes('æ­¥è¡Œ') || lower.includes('äº¤é€š')) {
                        parseMode = "TRANSFER";
                    } else if (lower.includes('é¤') || lower.includes('é£Ÿ') || lower.includes('æ™šé¤') || lower.includes('æ¨è–¦')) {
                        parseMode = "FOOD";
                    } else if (lower.includes('è‡ªè²»')) {
                        parseMode = "COST";
                    } else if (lower.includes('æç¤º') || lower.includes('è³¼ç‰©')) {
                        parseMode = "TIPS"; // æ–°å¢æç¤ºæ¨¡å¼
                    } else if (lower.includes('å‚™æ¡ˆ')) {
                        parseMode = "BACKUP"; // æ–°å¢å‚™æ¡ˆæ¨¡å¼
                    } else {
                        parseMode = "OTHER";
                    }
                    // æ¨™é¡Œè¡Œæœ¬èº«ä¸å­˜ï¼Œä½†å¦‚æœæ˜¯è¡¨æ ¼æ¨™é¡Œå¯èƒ½éœ€è¦ä¿ç•™ï¼Œé€™è£¡ç°¡å–®è·³é
                    return; 
                }

                // 3. åµæ¸¬å–®è¡Œè‡ªè²»
                if (trimmed.includes('ğŸ’¡') && trimmed.includes('è‡ªè²»')) {
                     newDayMeta[parsingDay].cost = trimmed.replace(/\*\*/g, '');
                     return;
                }

                // 4. æ ¹æ“šæ¨¡å¼å­˜å…¥å…§å®¹
                if (parseMode === "SCHEDULE") {
                    if (trimmed.startsWith('|') && !trimmed.includes('---')) {
                        const cols = trimmed.split('|').map(c => c.replace(/\*\*/g, '').replace(/\[(.*?)\]\(.*?\)/g, '$1').trim());
                        // MDè¡¨æ ¼é€šå¸¸ cols[0] æ˜¯ç©ºå­—ä¸²(å› ç‚º | é–‹é ­)ï¼Œæ‰€ä»¥ cols[1] æ˜¯ç¬¬ä¸€æ¬„
                        if (cols.length < 3) return; // è‡³å°‘è¦æœ‰æ™‚é–“è·Ÿåç¨±

                        let time = cols[1]; // æ™‚é–“æ¬„
                        let name = cols[2]; // åç¨±/åœ°é»
                        let location = cols[3] || ""; 
                        let note = cols[4] || ""; 
                        let transTime = "";

                        // Header row check
                        if (time.includes('æ™‚é–“') || name.includes('è¡Œç¨‹å…§å®¹') || name.includes('åœç•™é»')) return;
                        
                        // **é‡è¦ä¿®æ­£**ï¼šå³ä½¿æ™‚é–“ç‚ºç©ºï¼Œè‹¥å¾Œé¢æœ‰å…§å®¹ï¼Œä»è¦–ç‚ºæœ‰æ•ˆè¡Œç¨‹
                        const isDetail = (!time || time.trim() === "");

                        // æœ‰äº›è¡¨æ ¼æ ¼å¼å¯èƒ½æ˜¯: æ™‚é–“ | è¡Œç¨‹ | äº¤é€šæ–¹å¼ | å‚™è¨»
                        // å¦‚æœæ˜¯é€™ç¨®ï¼Œcols[3] å¯èƒ½æ˜¯äº¤é€šæ–¹å¼ï¼Œé€™å¾ˆé‡è¦
                        if (isDetail && cols[3] && cols[3] !== "-") {
                             // å¦‚æœæ™‚é–“ç©ºï¼Œä½†æœ‰äº¤é€šæ–¹å¼ï¼ŒæŠŠäº¤é€šæ–¹å¼åŠ åˆ° note æˆ– location
                             note = (cols[3] + " " + note).trim();
                        }

                        if (name && name !== "-") {
                            newItems.push({
                                id: Date.now() + Math.random(),
                                day: parsingDay,
                                time: isDetail ? "" : time,
                                name: name,
                                location: location,
                                note: note,
                                isDetail: isDetail,
                                img: null
                            });
                        }
                    }
                } else if (parseMode === "TRANSFER") {
                    if (trimmed) newDayMeta[parsingDay].transfer += line + "\n";
                } else if (parseMode === "FOOD") {
                    if (trimmed) newDayMeta[parsingDay].food += line + "\n";
                } else if (parseMode === "TIPS") {
                    if (trimmed) newDayMeta[parsingDay].tips += line + "\n";
                } else if (parseMode === "BACKUP") {
                    if (trimmed) newDayMeta[parsingDay].backup += line + "\n";
                }
            });

            if (newItems.length > 0) {
                if (confirm(`è§£æå®Œæˆï¼\næ‰¾åˆ° ${newItems.length} å€‹è¡Œç¨‹é …ç›®ã€‚\næ˜¯å¦åŒ¯å…¥ï¼Ÿ`)) {
                    appData.itinerary = newItems;
                    appData.dayMeta = newDayMeta;
                    appData.overviewMarkdown = newOverviewMD; // å„²å­˜ç¸½è¦½ MD
                    
                    const days = [...new Set(newItems.map(i => i.day))];
                    currentDayFilter = days[0] || "Day 1";
                    document.getElementById('trip-days-count').innerText = `${days.length} å¤©è¡Œç¨‹`;

                    saveData();
                    renderTabs();
                    renderItinerary();
                    renderOverview();
                    switchTab('home');
                }
            } else {
                alert("æœªåµæ¸¬åˆ°æœ‰æ•ˆè¡Œç¨‹ï¼Œè«‹ç¢ºèª Markdown æ ¼å¼ã€‚");
            }
        }

        // --- 4. Highlighting Logic ---
        function highlightContent(text) {
            if (!text) return "";
            
            let html = text
                .replace(/(å¿…é»|æ‹›ç‰Œ|èœå–®|é™å®š)/g, '<span class="tag-menu"><i class="fa-solid fa-star text-xs mr-1"></i>$1</span>')
                .replace(/(å¿…åƒ|ç¾å‘³|å¥½å‘³|æ¨è–¦)/g, '<span class="tag-eat"><i class="fa-solid fa-utensils text-xs mr-1"></i>$1</span>')
                .replace(/(å¿…è²·|ä¼´æ‰‹ç¦®|è—¥å¦|æŠ˜åƒ¹åˆ¸|æŠ˜æ‰£|å„ªæƒ åˆ¸)/g, '<span class="tag-buy"><i class="fa-solid fa-bag-shopping text-xs mr-1"></i>$1</span>')
                .replace(/(é ç´„|è¨‚ä½|ä»£è™Ÿ|å®¢æ»¿|æ’éšŠ|é–€ç¥¨|æ•´ç†åˆ¸)/g, '<span class="tag-res"><i class="fa-solid fa-clipboard-check text-xs mr-1"></i>$1</span>')
                .replace(/(å‘¨éŠåˆ¸|ç‰¹æ€¥|æ–°å¹¹ç·š|JR|å·´å£«|åœ°éµ|åˆ—è»Š|rapit|haruka)/gi, '<span class="tag-imp">$1</span>');
            
            return html;
        }

        function getUniqueAITip(name, location, seenSet) {
            const text = (name + location).toLowerCase();
            const database = [
                { k: 'ç’°çƒå½±åŸ', v: 'ä»»å¤©å ‚ä¸–ç•Œå»ºè­°ä¸€æ—©æŠ½å–æ•´ç†åˆ¸ï¼Œä¸¦æº–å‚™å¿«é€Ÿé€šé—œã€‚' },
                { k: 'usj', v: 'å¦‚æœä¸æƒ³è²·å¿«é€šï¼Œå–®äººé€šé“ (Single Rider) æ˜¯çœæ™‚å¥½é¸æ“‡ã€‚' },
                { k: 'é›£æ³¢', v: 'åœ°ä¸‹è¡—éŒ¯ç¶œè¤‡é›œï¼Œå»ºè­°èªæº–åœ°æ¨™ã€Œé«˜å³¶å±‹ã€æˆ–ã€Œå—æµ·é›»éµã€æ–¹ä½ã€‚' },
                { k: 'é³¥å–', v: 'ç ‚ä¸˜é¢¨å¤§è«‹æ³¨æ„é˜²æ²™ï¼ŒæŸ¯å—æ©Ÿå ´å·´å£«ç­æ¬¡è¼ƒå°‘éœ€ç•™æ„æ™‚é–“ã€‚' },
                { k: 'å²¡å±±', v: 'è³¼è²·ã€Œå²¡å±±æ¨‚äº«å‘¨éŠåˆ¸ã€å¯å…è²»é€²å…¥å¤šå€‹æ™¯é»ï¼ŒCPå€¼æ¥µé«˜ã€‚' },
                { k: 'è‡¨ç©ºåŸ', v: 'Outlet æœ‰ç½®ç‰©æ«ƒï¼Œä½†éŠå®¢ä¸­å¿ƒå¯„æ”¾è¡Œææ›´ä¾¿å®œä¸”ä¸é™å¤§å°ã€‚' }
            ];

            const match = database.find(r => text.includes(r.k));
            if (match) {
                if (seenSet.has(match.v)) return "";
                seenSet.add(match.v);
                return `<div class="ai-box"><i class="fa-solid fa-robot text-lg mt-0.5"></i><div>${match.v}</div></div>`;
            }
            return "";
        }

        // --- 5. Rendering Logic ---
        function renderOverview() {
            const container = document.getElementById('overview-section');
            const content = document.getElementById('overview-content');
            
            if (appData.overviewMarkdown && appData.overviewMarkdown.trim()) {
                container.classList.remove('hidden');
                // ä½¿ç”¨ marked.js å°‡ MD è¡¨æ ¼è½‰ç‚º HTML
                content.innerHTML = marked.parse(appData.overviewMarkdown);
            } else {
                container.classList.add('hidden');
            }
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('day-tabs');
            const allDays = [...new Set(appData.itinerary.map(item => item.day || "Day 1"))];
            
            if (!allDays.includes(currentDayFilter) && allDays.length > 0) currentDayFilter = allDays[0];

            tabsContainer.innerHTML = allDays.map(day => {
                const isActive = day === currentDayFilter;
                let mainText = day;
                let subText = "";
                const matchDay = day.match(/Day\s*\d+/i);
                const matchDate = day.match(/\((.*?)\)/);

                if (matchDay) mainText = matchDay[0];
                if (matchDate) subText = matchDate[1].split(',')[0]; 

                const activeClass = "bg-primary text-white shadow-md border-primary ring-2 ring-blue-100";
                const inactiveClass = "bg-white text-gray-500 border-gray-200";

                return `
                    <button onclick="switchDayFilter('${day}')" 
                            class="flex-shrink-0 px-4 py-2 rounded-xl text-center border transition-all min-w-[70px] ${isActive ? activeClass : inactiveClass}">
                        <div class="font-bold text-sm leading-none">${mainText}</div>
                        ${subText ? `<div class="text-[10px] opacity-80 mt-1 font-mono">${subText}</div>` : ''}
                    </button>
                `;
            }).join('');
            
            document.getElementById('current-day-title').innerText = currentDayFilter;
        }

        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            const summaryContainer = document.getElementById('day-summary-container');
            const bottomSection = document.getElementById('bottom-summary-section');
            
            list.innerHTML = '';
            summaryContainer.innerHTML = '';
            bottomSection.classList.add('hidden'); 

            const filteredItems = appData.itinerary.filter(item => (item.day || "Day 1") === currentDayFilter);
            const seenAITips = new Set();

            if (filteredItems.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-gray-400"><p>æœ¬æ—¥å°šç„¡è¡Œç¨‹</p></div>`;
            } else {
                filteredItems.forEach((item) => {
                    const li = document.createElement('li');
                    li.setAttribute('data-id', item.id);
                    
                    const hlName = highlightContent(item.name);
                    const hlNote = highlightContent(item.note);
                    const aiTip = getUniqueAITip(item.name, item.location, seenAITips); 

                    const deleteBtn = `<button onclick="deleteItem(${item.id})" class="ml-2 text-red-300 hover:text-red-500 transition px-2"><i class="fa-solid fa-trash-can"></i></button>`;

                    if (item.isDetail) {
                        li.className = "relative ml-8 mb-2 p-3 bg-gray-50/80 rounded-lg border-l-2 border-gray-300 group flex justify-between items-start";
                        li.innerHTML = `
                            <div class="flex-1 cursor-pointer" onclick="openEditModal(${item.id})">
                                <div class="text-sm text-gray-600 font-medium">${hlName}</div>
                                ${item.note ? `<div class="text-xs text-gray-500 mt-1">${hlNote}</div>` : ''}
                                ${aiTip}
                                ${item.img ? `<img src="${item.img}" class="mt-2 h-20 rounded-lg object-cover border">` : ''}
                            </div>
                            <div class="flex items-center">
                                <button onclick="triggerPhotoUpload(${item.id})" class="text-gray-300 hover:text-blue-500 photo-btn p-2"><i class="fa-solid fa-camera"></i></button>
                                ${deleteBtn}
                                <div class="drag-handle text-gray-300 cursor-grab p-2"><i class="fa-solid fa-bars"></i></div>
                            </div>
                        `;
                    } else {
                        li.className = "relative bg-white p-4 rounded-xl shadow-sm border border-gray-100 group mb-4 transition-all hover:shadow-md";
                        li.innerHTML = `
                            <div class="absolute -left-[24px] top-6 w-3 h-3 rounded-full bg-primary border-2 border-white shadow-sm z-10"></div>
                            <div class="absolute left-[-19px] top-9 bottom-[-30px] w-0.5 bg-gray-200 -z-10"></div>
                            
                            <div class="flex justify-between items-start">
                                <div class="drag-handle text-gray-300 hover:text-gray-500 cursor-grab pt-1 pr-3"><i class="fa-solid fa-grip-vertical"></i></div>
                                <div class="flex-1 cursor-pointer" onclick="openEditModal(${item.id})">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-mono text-xl font-bold text-gray-800">${item.time}</span>
                                    </div>
                                    <h4 class="font-bold text-gray-800 text-lg leading-snug">${hlName}</h4>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        ${item.location ? `<span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded"><i class="fa-solid fa-location-dot mr-1"></i>${item.location}</span>` : ''}
                                        ${item.note ? `<span class="text-xs text-gray-600">${hlNote}</span>` : ''}
                                    </div>
                                    ${aiTip}
                                    ${item.img ? `<div class="mt-3 relative w-full h-32 bg-gray-100 rounded-lg overflow-hidden"><img src="${item.img}" class="w-full h-full object-cover"></div>` : ''}
                                </div>
                                <div class="flex flex-col gap-2 ml-3 pt-1 items-center">
                                    <button onclick="openMap('${item.name}')" class="text-gray-300 hover:text-primary p-1"><i class="fa-solid fa-diamond-turn-right text-xl"></i></button>
                                    <button onclick="triggerPhotoUpload(${item.id})" class="text-gray-300 hover:text-blue-500 photo-btn p-1"><i class="fa-solid fa-camera text-lg"></i></button>
                                    ${deleteBtn}
                                </div>
                            </div>
                        `;
                    }
                    list.appendChild(li);
                });
            }

            // Render Bottom Summary
            const meta = appData.dayMeta[currentDayFilter];
            let hasSummary = false;
            
            if (meta) {
                // è‡ªè²»
                if (meta.cost && meta.cost.trim()) {
                    summaryContainer.innerHTML += `
                        <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 flex items-start gap-3">
                            <i class="fa-solid fa-wallet text-yellow-600 mt-1"></i>
                            <div>
                                <h4 class="font-bold text-yellow-800 text-sm mb-1">ç¸½è‡ªè²»é ä¼°</h4>
                                <p class="text-sm text-yellow-900">${meta.cost}</p>
                            </div>
                        </div>`;
                    hasSummary = true;
                }
                
                // æç¤º (Tips) - New
                if (meta.tips && meta.tips.trim()) {
                    summaryContainer.innerHTML += `
                        <div class="bg-green-50 p-4 rounded-xl border border-green-200 info-block">
                            <h4 class="font-bold text-green-800 text-sm mb-2 flex items-center"><i class="fa-solid fa-lightbulb mr-2"></i>è³¼ç‰©/å„ªæƒ æç¤º</h4>
                            <div class="text-sm text-gray-700 overflow-x-auto">${marked.parse(meta.tips)}</div>
                        </div>`;
                    hasSummary = true;
                }

                // å‚™æ¡ˆ (Backup) - New
                if (meta.backup && meta.backup.trim()) {
                    summaryContainer.innerHTML += `
                        <div class="bg-gray-100 p-4 rounded-xl border border-gray-300 info-block">
                            <h4 class="font-bold text-gray-800 text-sm mb-2 flex items-center"><i class="fa-solid fa-umbrella mr-2"></i>å‚™æ¡ˆè¡Œç¨‹</h4>
                            <div class="text-sm text-gray-700 overflow-x-auto">${marked.parse(meta.backup)}</div>
                        </div>`;
                    hasSummary = true;
                }

                // é¤é£²
                if (meta.food && meta.food.trim()) {
                    summaryContainer.innerHTML += `
                        <div class="bg-rose-50 p-4 rounded-xl border border-rose-200 info-block">
                            <h4 class="font-bold text-rose-800 text-sm mb-2 flex items-center"><i class="fa-solid fa-utensils mr-2"></i>é¤é£²æ¨è–¦</h4>
                            <div class="text-sm text-gray-700 overflow-x-auto">${marked.parse(meta.food)}</div>
                        </div>`;
                    hasSummary = true;
                }

                // è½‰ä¹˜
                if (meta.transfer && meta.transfer.trim()) {
                    summaryContainer.innerHTML += `
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 info-block">
                            <h4 class="font-bold text-blue-800 text-sm mb-2 flex items-center"><i class="fa-solid fa-train-subway mr-2"></i>è½‰ä¹˜/æ­¥è¡Œå»ºè­°</h4>
                            <div class="text-sm text-gray-700 overflow-x-auto">${marked.parse(meta.transfer)}</div>
                        </div>`;
                    hasSummary = true;
                }
            }
            
            if (hasSummary) {
                bottomSection.classList.remove('hidden');
            }
        }

        // --- 6. Helper Functions ---
        function initNotepad() {
            const area = document.getElementById('notepad-area');
            if (appData.notepadContent) {
                area.value = appData.notepadContent;
            }
            area.addEventListener('input', (e) => {
                appData.notepadContent = e.target.value;
                saveData();
            });
        }

        function deleteItem(id) {
            if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹é …ç›®å—ï¼Ÿ")) {
                appData.itinerary = appData.itinerary.filter(item => item.id !== id);
                saveData();
                renderItinerary();
            }
        }

        function handleMDImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => parseMD(e.target.result);
            reader.readAsText(file);
            input.value = '';
        }

        function switchDayFilter(day) {
            currentDayFilter = day;
            renderTabs();
            renderItinerary();
        }

        function switchTab(tabId) {
            ['home', 'itinerary', 'notepad', 'tools'].forEach(id => document.getElementById(`view-${id}`).classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-primary');
                if(btn.dataset.target === tabId) btn.classList.add('text-primary');
            });
            const titles = { home: "æˆ‘çš„æ—…ç¨‹", itinerary: "è¡Œç¨‹è¦åŠƒ", notepad: "éš¨æ‰‹ç­†è¨˜", tools: "æ—…è¡Œå·¥å…·" };
            document.getElementById('header-title').innerText = titles[tabId];
        }

        function triggerPhotoUpload(id) {
            activePhotoId = id;
            document.getElementById('photo-input').click();
        }

        function handlePhotoProcess(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('compress-canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800;
                    let w = img.width;
                    let h = img.height;
                    if (w > maxWidth) { h *= maxWidth/w; w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    const item = appData.itinerary.find(i => i.id === activePhotoId);
                    if(item) { item.img = dataUrl; saveData(); renderItinerary(); }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        function initSortable() {
            const el = document.getElementById('itinerary-list');
            new Sortable(el, {
                handle: '.drag-handle',
                animation: 150,
                delay: 150,
                delayOnTouchOnly: true,
                onEnd: function (evt) {
                    const newIds = Array.from(el.children).map(li => parseFloat(li.getAttribute('data-id')));
                    const currentItems = appData.itinerary.filter(item => (item.day || "Day 1") === currentDayFilter);
                    const otherItems = appData.itinerary.filter(item => (item.day || "Day 1") !== currentDayFilter);
                    
                    const sortedCurrent = [];
                    newIds.forEach(id => {
                        const item = currentItems.find(i => i.id === id);
                        if(item) sortedCurrent.push(item);
                    });
                    
                    appData.itinerary = [...otherItems, ...sortedCurrent];
                    appData.itinerary.sort((a,b) => (a.day||"").localeCompare(b.day||""));
                    saveData();
                }
            });
        }

        function openEditModal(id) {
            const item = appData.itinerary.find(i => i.id === id);
            if(!item) return;
            document.getElementById('edit-id').value = item.id;
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-time').value = item.time;
            document.getElementById('edit-location').value = item.location;
            document.getElementById('edit-note').value = item.note;
            document.getElementById('edit-modal').classList.remove('hidden');
        }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
        function saveEdit() {
            const id = parseFloat(document.getElementById('edit-id').value);
            const item = appData.itinerary.find(i => i.id === id);
            if(item) {
                item.name = document.getElementById('edit-name').value;
                item.time = document.getElementById('edit-time').value;
                item.location = document.getElementById('edit-location').value;
                item.note = document.getElementById('edit-note').value;
                item.isDetail = (item.time.trim() === "");
                saveData(); renderItinerary(); closeEditModal();
            }
        }
        function addNewItem() {
            appData.itinerary.push({id: Date.now(), day: currentDayFilter, time: "10:00", name: "æ–°è¡Œç¨‹", location: "", note: "", isDetail: false, img: null});
            saveData(); renderItinerary();
        }

        function fetchExchangeRate() {
            fetch('https://api.exchangerate-api.com/v4/latest/JPY')
            .then(r=>r.json()).then(d=>{
                appData.rate = d.rates.TWD;
                document.getElementById('home-rate').innerText = (100 * appData.rate).toFixed(2);
                document.getElementById('rate-display').innerText = `1 JPY â‰ˆ ${appData.rate} TWD`;
                saveData();
            }).catch(e=>console.log(e));
        }
        function calcCurrency(src) {
            const t = document.getElementById('curr-twd'), j = document.getElementById('curr-jpy');
            if(src==='twd') j.value = (t.value/appData.rate).toFixed(0);
            else t.value = (j.value*appData.rate).toFixed(0);
        }
        function openMap(q) { window.location.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`; }
        function saveData() { localStorage.setItem('travelApp_v8', JSON.stringify(appData)); }
        function resetData() { if(confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { localStorage.removeItem('travelApp_v8'); location.reload(); } }
        
        function exportToPDF() {
            if(appData.itinerary.length === 0) { alert("ç„¡è³‡æ–™"); return; }
            const printArea = document.getElementById('print-area');
            const days = [...new Set(appData.itinerary.map(i => i.day))].sort();
            let html = `<h1 style="text-align:center; font-size:24px; margin-bottom:20px;">${appData.tripName}</h1>`;
            
            // åŠ å…¥ç¸½è¦½è¡¨æ ¼
            if (appData.overviewMarkdown) {
                html += `<h3>è¡Œç¨‹ç¸½è¦½</h3><div>${marked.parse(appData.overviewMarkdown)}</div><hr>`;
            }

            days.forEach(day => {
                const items = appData.itinerary.filter(i => i.day === day);
                const meta = appData.dayMeta[day];
                
                const rows = items.map(i => `
                    <tr><td style="width:15%;border-bottom:1px solid #ddd;padding:5px;">${i.time}</td>
                    <td style="width:40%;border-bottom:1px solid #ddd;padding:5px;"><b>${i.name}</b><br><small>${i.location}</small></td>
                    <td style="border-bottom:1px solid #ddd;padding:5px;">${i.note}</td></tr>
                `).join('');
                
                html += `<h3 style="background:#eee;padding:5px;margin-top:20px;">${day}</h3>
                <table style="width:100%;border-collapse:collapse;font-size:12px;">${rows}</table>`;
                
                if(meta) {
                    if(meta.cost) html += `<div style="margin-top:5px;font-size:12px;"><b>è‡ªè²»:</b> ${meta.cost}</div>`;
                    if(meta.tips) html += `<div style="margin-top:5px;font-size:12px;"><b>æç¤º:</b><br>${marked.parse(meta.tips)}</div>`;
                    if(meta.backup) html += `<div style="margin-top:5px;font-size:12px;"><b>å‚™æ¡ˆ:</b><br>${marked.parse(meta.backup)}</div>`;
                    if(meta.food) html += `<div style="margin-top:5px;font-size:12px;"><b>é¤é£²:</b><br>${marked.parse(meta.food)}</div>`;
                    if(meta.transfer) html += `<div style="margin-top:5px;font-size:12px;"><b>è½‰ä¹˜:</b><br>${marked.parse(meta.transfer)}</div>`;
                }
            });
            printArea.innerHTML = html;
            window.print();
        }
    </script>
</body>
</html>