<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æœ¬è¦åŠƒ V14 </title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // 1. å…¨å±€éŒ¯èª¤æ””æˆª
        window.onerror = function(msg, url, line, col, error) {
            console.error("Error:", msg, error);
            return false;
        };

        // 2. å¼·åˆ¶é‡ç½®åŠŸèƒ½
        function forceResetApp() {
            if(confirm('ã€è­¦å‘Šã€‘é€™å°‡æœƒå¼·åˆ¶æ¸…é™¤æ‰€æœ‰è¡Œç¨‹è³‡æ–™ä¸¦é‡æ•´é é¢ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                try {
                    localStorage.removeItem('travelApp_v14'); // æ›´æ–°ç‚º v14
                    localStorage.removeItem('travelApp_v11');
                    localStorage.removeItem('travelApp_v9'); 
                } catch(e) { console.error(e); }
                window.location.reload();
            }
        }

        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#0EA5E9', secondary: '#64748B', accent: '#F59E0B' },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        body { -webkit-tap-highlight-color: transparent; }
        
        /* Tags */
        .tag-eat { color: #9f1239; background-color: #ffe4e6; font-weight: 800; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; border: 1px solid #fda4af; }
        .tag-menu { color: #b45309; background-color: #fffbeb; font-weight: 800; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; border-bottom: 2px solid #f59e0b; }
        .tag-buy { color: #15803d; background-color: #dcfce7; font-weight: 800; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; border: 1px solid #86efac; }
        .tag-res { color: #ffffff; background-color: #7c3aed; font-weight: 800; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; box-shadow: 2px 2px 0px #5b21b6; }
        .tag-imp { color: #1e40af; background-color: #dbeafe; font-weight: 800; padding: 0 4px; text-decoration: underline; text-underline-offset: 4px; text-decoration-color: #3b82f6; }

        .info-block { @apply shadow-sm transition-all hover:shadow-md; }
        .info-block table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 0.85rem; background: rgba(255,255,255,0.5); }
        .info-block th { background: rgba(0,0,0,0.05); padding: 8px; text-align: left; border: 1px solid rgba(0,0,0,0.1); font-weight: bold; color: #374151; }
        .info-block td { padding: 8px; border: 1px solid rgba(0,0,0,0.1); vertical-align: top; }
        .info-block ul { list-style-type: disc; padding-left: 20px; margin: 5px 0; }
        .info-block ol { list-style-type: decimal; padding-left: 20px; margin: 5px 0; }
        .info-block a { color: #0EA5E9; text-decoration: underline; }
        .info-block p { margin-bottom: 0.5rem; }

        .overview-table-container table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; }
        .overview-table-container th { background-color: #f1f5f9; color: #334155; font-weight: bold; padding: 10px; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        .overview-table-container td { padding: 10px; border-bottom: 1px solid #f1f5f9; color: #475569; }
        .overview-table-container tr:last-child td { border-bottom: none; }

        .weather-card {
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            border-bottom: 1px solid #bae6fd;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #0c4a6e;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .weather-btn {
            background-color: #fff;
            border: 1px solid #bae6fd;
            color: #0284c7;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            cursor: pointer;
            z-index: 50;
        }
        .weather-btn:active { transform: scale(0.95); background-color: #f0f9ff; }

        @media print {
            .no-print, header, nav, .drag-handle, .add-btn, button, input[type="file"], .photo-btn { display: none !important; }
            #print-area { display: block !important; padding: 20px; font-family: serif; }
            body { background: white; height: auto; overflow: visible; }
            .print-break { page-break-before: always; }
            #view-itinerary { display: none; }
        }
        #print-area { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <header class="no-print bg-white shadow-sm px-4 py-3 flex justify-between items-center z-30 shrink-0 relative">
        <div class="flex items-center gap-2">
            <div class="bg-gradient-to-tr from-primary to-blue-400 text-white rounded-lg w-9 h-9 flex items-center justify-center shadow-lg shadow-blue-200">
                <i class="fa-solid fa-plane-departure"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight" id="header-title">æˆ‘çš„æ—…ç¨‹</h1>
                <p class="text-[10px] text-gray-400">V14 è‡ªè²»ä¿®å¾©ç‰ˆ</p>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="document.getElementById('file-upload-header').click()" class="text-gray-500 hover:text-primary p-2 rounded-full active:bg-gray-100" title="åŒ¯å…¥è¡Œç¨‹">
                <i class="fa-solid fa-file-import"></i>
            </button>
        </div>
        <input type="file" id="file-upload-header" class="hidden" accept=".md,.txt" onchange="handleMDImport(this)">
    </header>

    <main class="no-print flex-1 overflow-y-auto no-scrollbar relative safe-bottom pb-24" id="main-container">
        
        <div id="view-home" class="p-4 space-y-6 animate-fade-in">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-6 text-white shadow-xl shadow-blue-200 relative overflow-hidden">
                <div class="absolute right-[-10px] top-[-10px] opacity-20 transform rotate-12">
                    <i class="fa-solid fa-earth-asia text-9xl"></i>
                </div>
                <div class="relative z-10">
                    <p class="text-blue-100 text-sm mb-1"><i class="fa-solid fa-calendar-days mr-1"></i>æ—…ç¨‹ç‹€æ…‹</p>
                    <h2 class="text-3xl font-bold mb-3 tracking-wide" id="trip-days-count">è¦åŠƒä¸­</h2>
                    <div class="flex gap-2">
                         <button onclick="switchTab('itinerary')" class="bg-white/20 hover:bg-white/30 backdrop-blur-md px-4 py-2 rounded-lg text-sm transition cursor-pointer z-10">
                            <i class="fa-solid fa-list-check mr-1"></i> æŸ¥çœ‹è¡Œç¨‹
                        </button>
                        <button onclick="switchTab('tools')" class="bg-white text-blue-600 px-4 py-2 rounded-lg text-sm font-bold shadow-sm active:scale-95 transition cursor-pointer z-10">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> å·¥å…·ç®±
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden group cursor-pointer" onclick="switchTab('tools')">
                    <div class="absolute right-2 top-2 text-green-100 text-5xl group-hover:scale-110 transition"><i class="fa-solid fa-money-bill-wave"></i></div>
                    <p class="text-xs text-gray-500 mb-1">åŒ¯ç‡ (JPY)</p>
                    <h3 class="text-2xl font-bold text-gray-800 font-mono" id="home-rate">...</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden group">
                     <div class="absolute right-2 top-2 text-yellow-100 text-5xl group-hover:scale-110 transition"><i class="fa-solid fa-cloud-sun"></i></div>
                    <p class="text-xs text-gray-500 mb-1">å¤§é˜ªå¤©æ°£</p>
                    <h3 class="text-2xl font-bold text-gray-800 font-mono" id="home-weather-temp">--Â°C</h3>
                    <p class="text-[10px] text-orange-500 mt-1" id="home-weather-desc">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
            
            <div id="overview-section" class="hidden">
                 <h3 class="font-bold text-gray-700 text-lg mb-2 pl-1 border-l-4 border-primary">è¡Œç¨‹ç¸½è¦½</h3>
                 <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden overflow-x-auto overview-table-container p-2" id="overview-content"></div>
            </div>
        </div>

        <div id="view-itinerary" class="hidden flex flex-col min-h-full animate-fade-in relative">
            <div class="sticky top-0 z-20 bg-gray-50/95 backdrop-blur shadow-sm">
                <div id="day-tabs" class="flex overflow-x-auto no-scrollbar gap-2 px-4 py-3 border-b border-gray-200">
                    </div>
                <div id="weather-widget" class="weather-card">
                    <div class="flex items-center">
                        <div id="ww-icon" class="weather-icon text-gray-400"><i class="fa-solid fa-spinner fa-spin"></i></div>
                        <div>
                            <div class="flex items-baseline gap-2">
                                <span id="ww-city" class="font-bold text-gray-800">å¤§é˜ª</span>
                                <span id="ww-date" class="text-xs text-gray-500">--/--</span>
                            </div>
                            <div class="text-xs mt-0.5">
                                <span id="ww-temp" class="font-bold text-lg mr-2">--Â°C</span>
                                <span id="ww-rain" class="text-blue-500"><i class="fa-solid fa-umbrella mr-1"></i>--%</span>
                            </div>
                        </div>
                    </div>
                    <button id="ww-link" class="weather-btn">
                        <i class="fa-solid fa-up-right-from-square"></i>
                        Tenki.jp è©³ç´°
                    </button>
                </div>
            </div>

            <div class="p-4 pt-4 flex-1">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="font-bold text-gray-700 text-lg" id="current-day-title">Day 1</h3>
                    <span class="text-xs text-gray-400 bg-gray-200 px-2 py-1 rounded-full"><i class="fa-solid fa-arrows-up-down mr-1"></i>é•·æŒ‰æ‹–æ›³</span>
                </div>

                <ul id="itinerary-list" class="space-y-4 mb-8 min-h-[100px]"></ul>

                <div id="bottom-summary-section" class="hidden animate-fade-in">
                    <div class="border-t-2 border-dashed border-gray-200 my-6 relative">
                        <span class="absolute top-[-12px] left-1/2 transform -translate-x-1/2 bg-gray-50 px-3 text-xs text-gray-400 font-bold tracking-wider"> ç•¶æ—¥è³‡è¨Šå½™æ•´ </span>
                    </div>
                    <div id="day-summary-container" class="space-y-4 pb-4"></div>
                </div>

                <button onclick="addNewItem()" class="w-full py-4 mt-4 border-2 border-dashed border-gray-300 text-gray-400 rounded-xl flex items-center justify-center gap-2 hover:bg-white hover:border-primary hover:text-primary transition active:scale-95 cursor-pointer">
                    <i class="fa-solid fa-plus"></i> æ–°å¢è¡Œç¨‹
                </button>
            </div>
        </div>

        <div id="view-notepad" class="hidden p-4 animate-fade-in h-full flex flex-col">
            <div class="bg-yellow-100 rounded-xl p-4 text-yellow-800 mb-4 shadow-sm border border-yellow-200">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-pen-to-square mr-2"></i>éš¨æ‰‹ç­†è¨˜</h3>
                <p class="text-xs text-yellow-700 mt-1">æ­¤è™•çš„å…§å®¹æœƒè‡ªå‹•å„²å­˜ã€‚</p>
            </div>
            <textarea id="notepad-area" class="flex-1 w-full bg-white border border-gray-200 rounded-xl p-4 shadow-sm focus:ring-2 focus:ring-primary focus:outline-none text-gray-700 leading-relaxed" placeholder="è¼¸å…¥ç­†è¨˜..."></textarea>
        </div>

        <div id="view-tools" class="hidden p-4 space-y-4 animate-fade-in">
            <label class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-5 rounded-2xl shadow-lg flex items-center justify-center gap-4 hover:shadow-xl transition cursor-pointer active:scale-95">
                <div class="bg-white/20 p-3 rounded-full"><i class="fa-solid fa-file-import text-2xl"></i></div>
                <div class="text-left flex-1">
                    <div class="font-bold text-lg">åŒ¯å…¥ Markdown è¡Œç¨‹</div>
                    <div class="text-xs text-blue-100">é»æ“Šé¸æ“‡æª”æ¡ˆ (.md / .txt)</div>
                </div>
                <input type="file" id="md-import-tools" class="hidden" accept=".md,.txt,.markdown" onchange="handleMDImport(this)">
            </label>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold mb-4 flex items-center gap-2 text-gray-700"><i class="fa-solid fa-coins text-yellow-500"></i> å³æ™‚åŒ¯ç‡æ›ç®—</h3>
                <div class="flex items-center gap-3 mb-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">TWD (å°å¹£)</label>
                        <input type="number" id="curr-twd" value="1000" oninput="calcCurrency('twd')" class="w-full bg-gray-50 p-3 rounded-xl font-mono text-xl outline-none focus:ring-2 focus:ring-primary transition text-center">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i>
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">JPY (æ—¥åœ“)</label>
                        <input type="number" id="curr-jpy" value="" oninput="calcCurrency('jpy')" class="w-full bg-gray-50 p-3 rounded-xl font-mono text-xl outline-none focus:ring-2 focus:ring-primary transition text-center">
                    </div>
                </div>
                <div class="text-center text-xs text-gray-400" id="rate-display">è¼‰å…¥ä¸­...</div>
            </div>

            <button onclick="exportToPDF()" class="w-full bg-gray-800 text-white p-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition cursor-pointer">
                <i class="fa-solid fa-print text-xl"></i>
                <div class="text-left flex-1">
                    <div class="font-bold">åŒ¯å‡ºè¡Œç¨‹å–® (PDF)</div>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-500"></i>
            </button>
             
             <div class="pt-4 border-t border-gray-200 mt-4">
                 <button onclick="forceResetApp()" class="w-full py-3 text-red-500 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 font-bold active:scale-95 transition cursor-pointer">
                    <i class="fa-solid fa-triangle-exclamation mr-2"></i>å¼·åˆ¶æ¸…é™¤æ‰€æœ‰è³‡æ–™ & é‡ç½®
                 </button>
             </div>
        </div>
    </main>

    <nav class="no-print bg-white border-t border-gray-200 fixed bottom-0 w-full z-40 safe-bottom shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around items-center h-16 px-2">
            <button onclick="switchTab('home')" class="nav-btn active flex-1 group" data-target="home">
                <div class="flex flex-col items-center gap-1 text-gray-400 group-hover:text-primary transition duration-300">
                    <div class="text-xl relative"><i class="fa-solid fa-house"></i></div>
                    <span class="text-[10px] font-medium">ç¸½è¦½</span>
                </div>
            </button>
            <button onclick="switchTab('itinerary')" class="nav-btn flex-1 group" data-target="itinerary">
                <div class="flex flex-col items-center gap-1 text-gray-400 group-hover:text-primary transition duration-300">
                    <div class="text-xl relative"><i class="fa-solid fa-map-location-dot"></i></div>
                    <span class="text-[10px] font-medium">è¡Œç¨‹</span>
                </div>
            </button>
            <button onclick="switchTab('notepad')" class="nav-btn flex-1 group" data-target="notepad">
                <div class="flex flex-col items-center gap-1 text-gray-400 group-hover:text-primary transition duration-300">
                    <div class="text-xl relative"><i class="fa-solid fa-pen-to-square"></i></div>
                    <span class="text-[10px] font-medium">è¨˜äº‹</span>
                </div>
            </button>
            <button onclick="switchTab('tools')" class="nav-btn flex-1 group" data-target="tools">
                <div class="flex flex-col items-center gap-1 text-gray-400 group-hover:text-primary transition duration-300">
                    <div class="text-xl relative"><i class="fa-solid fa-suitcase"></i></div>
                    <span class="text-[10px] font-medium">å·¥å…·</span>
                </div>
            </button>
        </div>
    </nav>

    <canvas id="compress-canvas" class="hidden"></canvas>
    <input type="file" id="photo-input" class="hidden" accept="image/*" capture="environment">

    <div id="edit-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-white rounded-2xl w-full max-w-sm p-5 shadow-2xl relative">
            <h3 class="font-bold text-lg mb-4">ç·¨è¼¯è¡Œç¨‹</h3>
            <div class="space-y-3">
                <input type="hidden" id="edit-id">
                <div><label class="text-xs text-gray-500">åç¨±</label><input type="text" id="edit-name" class="w-full border rounded-lg p-2 outline-none focus:ring-2 focus:ring-primary"></div>
                <div class="flex gap-2">
                    <div class="w-1/3"><label class="text-xs text-gray-500">æ™‚é–“</label><input type="text" id="edit-time" class="w-full border rounded-lg p-2 text-center"></div>
                    <div class="w-2/3"><label class="text-xs text-gray-500">åœ°é»</label><input type="text" id="edit-location" class="w-full border rounded-lg p-2"></div>
                </div>
                <div><label class="text-xs text-gray-500">å‚™è¨»</label><textarea id="edit-note" rows="3" class="w-full border rounded-lg p-2 text-sm"></textarea></div>
                <div class="flex gap-2 mt-4">
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg cursor-pointer">å–æ¶ˆ</button>
                    <button onclick="saveEdit()" class="flex-1 bg-primary text-white py-2 rounded-lg font-bold shadow-md cursor-pointer">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <div id="print-area"></div>

    <script>
        // --- 1. Data & State ---
        const defaultData = {
            tripName: "æˆ‘çš„æ—…ç¨‹",
            rate: 0.22,
            itinerary: [],
            dayMeta: {}, // V14 format: { "Day 1": [ {title: "Title", content: "...", type: "cost"|"normal"} ] }
            overviewMarkdown: "",
            notepadContent: ""
        };

        const cityData = {
            "å¤§é˜ª": { lat: 34.6937, lon: 135.5023, url: "https://tenki.jp/forecast/6/30/6200/27100/" },
            "äº¬éƒ½": { lat: 35.0116, lon: 135.7681, url: "https://tenki.jp/forecast/6/29/6110/26100/" },
            "é³¥å–": { lat: 35.5011, lon: 134.2351, url: "https://tenki.jp/forecast/7/34/6910/31201/" },
            "å²¡å±±": { lat: 34.6555, lon: 133.9198, url: "https://tenki.jp/forecast/7/36/6610/33100/" },
            "å¥ˆè‰¯": { lat: 34.6851, lon: 135.8048, url: "https://tenki.jp/forecast/6/29/6410/29201/" },
            "æ±äº¬": { lat: 35.6895, lon: 139.6917, url: "https://tenki.jp/forecast/3/16/4410/13101/" }
        };

        let appData = defaultData;
        let currentDayFilter = "Day 1";
        let activePhotoId = null;

        // --- 2. Robust Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const stored = localStorage.getItem('travelApp_v14'); // V14 key
                
                if (stored) {
                    appData = JSON.parse(stored);
                } else {
                     // Try to migrate old V11 data
                     const oldStored = localStorage.getItem('travelApp_v11');
                     if(oldStored) {
                         try {
                            const oldData = JSON.parse(oldStored);
                            appData = { ...defaultData, ...oldData };
                            saveData(); 
                         } catch(e) {
                             console.error("Migration failed", e);
                             appData = defaultData;
                         }
                     }
                }

                if(!appData.itinerary) appData.itinerary = [];
                if(!appData.dayMeta) appData.dayMeta = {};

            } catch (e) {
                console.error("Data corrupted, resetting to default", e);
                appData = defaultData;
            }

            try { fetchExchangeRate(); } catch(e) { console.log(e); }
            try { fetchHomeWeather(); } catch(e) { console.log(e); }
            try { renderTabs(); } catch(e) { console.log("Tab Error", e); }
            try { renderItinerary(); } catch(e) { console.log("Itinerary Error", e); }
            try { renderOverview(); } catch(e) { console.log("Overview Error", e); }
            try { initNotepad(); } catch(e) { console.log("Notepad Error", e); }
            
            try {
                if (typeof Sortable !== 'undefined') {
                    initSortable();
                }
            } catch (e) { console.warn("Sortable init failed", e); }

            const photoInput = document.getElementById('photo-input');
            if(photoInput) photoInput.addEventListener('change', handlePhotoProcess);
            
            switchTab('home');
        });

        // --- Core Functions ---
        
        function getCityForDay(day) {
            const items = appData.itinerary.filter(i => i.day === day);
            const dayTitle = day || "";
            const combinedText = (dayTitle + " " + items.map(i => i.name||"").join(" ")).toLowerCase(); 

            if(combinedText.includes("é³¥å–") || combinedText.includes("å€‰å‰") || combinedText.includes("æŸ¯å—") || combinedText.includes("ç”±è‰¯")) return "é³¥å–";
            if(combinedText.includes("å²¡å±±") || combinedText.includes("å€‰æ•·")) return "å²¡å±±";
            if(combinedText.includes("å¥ˆè‰¯")) return "å¥ˆè‰¯";
            if(combinedText.includes("äº¬éƒ½") || combinedText.includes("ä¸‹é´¨") || combinedText.includes("æ¸…æ°´å¯º") || combinedText.includes("åµå±±")) return "äº¬éƒ½";
            if(combinedText.includes("æ±äº¬") || combinedText.includes("æ¾€è°·") || combinedText.includes("æ–°å®¿")) return "æ±äº¬";
            return "å¤§é˜ª"; 
        }

        function parseDateFromDay(dayStr) {
            if(!dayStr) return new Date().toISOString().split('T')[0];
            const match = dayStr.match(/(\d{1,2})\/(\d{1,2})/);
            if(match) {
                const currentYear = new Date().getFullYear();
                return `${currentYear}-${match[1].padStart(2, '0')}-${match[2].padStart(2, '0')}`;
            }
            return new Date().toISOString().split('T')[0];
        }

        function updateWeatherWidget(dayStr) {
            try {
                const cityName = getCityForDay(dayStr);
                const dateStr = parseDateFromDay(dayStr);
                const city = cityData[cityName] || cityData["å¤§é˜ª"];
                
                const cityEl = document.getElementById('ww-city');
                const dateEl = document.getElementById('ww-date');
                const linkEl = document.getElementById('ww-link');
                const tempEl = document.getElementById('ww-temp');
                const rainEl = document.getElementById('ww-rain');
                const iconEl = document.getElementById('ww-icon');

                if(cityEl) cityEl.innerText = cityName;
                if(dateEl) dateEl.innerText = dateStr.slice(5).replace('-', '/');
                if(linkEl) {
                    linkEl.onclick = function() { window.open(city.url, '_blank'); };
                }
                if(iconEl) iconEl.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                if(tempEl) tempEl.innerText = '--Â°C';

                const url = `https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo&start_date=${dateStr}&end_date=${dateStr}`;

                fetch(url)
                .then(res => res.json())
                .then(data => {
                    if(data.daily && data.daily.time.length > 0) {
                        const code = data.daily.weathercode[0];
                        const maxT = data.daily.temperature_2m_max[0];
                        const minT = data.daily.temperature_2m_min[0];
                        const rain = data.daily.precipitation_probability_max[0];
                        if(tempEl) tempEl.innerText = `${Math.round((maxT+minT)/2)}Â°C`;
                        if(rainEl) rainEl.innerHTML = `<i class="fa-solid fa-umbrella mr-1"></i>${rain}%`;
                        if(iconEl) iconEl.innerHTML = getWeatherIcon(code);
                    } else {
                        if(tempEl) tempEl.innerText = '-';
                        if(iconEl) iconEl.innerHTML = '<i class="fa-solid fa-calendar-xmark"></i>';
                    }
                })
                .catch(err => {
                    if(iconEl) iconEl.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i>';
                });
            } catch(e) { console.error("Update Widget Error", e); }
        }

        function fetchHomeWeather() {
            const city = cityData["å¤§é˜ª"];
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${city.lat}&longitude=${city.lon}&current_weather=true&timezone=Asia%2FTokyo`)
            .then(r=>r.json()).then(d => {
                if(d.current_weather) {
                    const t = document.getElementById('home-weather-temp');
                    const desc = document.getElementById('home-weather-desc');
                    if(t) t.innerText = `${d.current_weather.temperature}Â°C`;
                    if(desc) desc.innerText = getWeatherDesc(d.current_weather.weathercode);
                }
            }).catch(e=>console.log("Home Weather Error", e));
        }

        function getWeatherIcon(code) {
            if(code === 0) return '<i class="fa-solid fa-sun text-orange-400"></i>';
            if(code <= 3) return '<i class="fa-solid fa-cloud-sun text-yellow-500"></i>';
            if(code <= 48) return '<i class="fa-solid fa-smog text-gray-400"></i>';
            if(code <= 67) return '<i class="fa-solid fa-cloud-rain text-blue-400"></i>';
            if(code <= 77) return '<i class="fa-solid fa-snowflake text-cyan-300"></i>';
            if(code >= 95) return '<i class="fa-solid fa-bolt text-yellow-400"></i>';
            return '<i class="fa-solid fa-cloud text-gray-400"></i>';
        }
        function getWeatherDesc(code) {
            if(code === 0) return "æ™´æœ—";
            if(code <= 3) return "å¤šé›²";
            if(code <= 67) return "æœ‰é›¨";
            return "é™°å¤©";
        }

        // 2. MD Parser (V14 Enhanced)
        function parseMD(text) {
            if (typeof marked === 'undefined') { alert("Markdown è§£æåº«è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚"); return; }
            
            const lines = text.split(/\r?\n/);
            const newItems = [];
            const newDayMeta = {};
            let newOverviewMD = "";
            let parsingDay = null; 
            let parseMode = "SCHEDULE"; 
            
            lines.forEach(line => {
                let trimmed = line.trim();

                if ((trimmed.startsWith('#') || trimmed.startsWith('##')) && trimmed.match(/Day/i)) {
                    if (!trimmed.includes('æ™šé¤') && !trimmed.includes('æ¨è–¦')) {
                        parsingDay = trimmed.replace(/#+\s*/, '').trim(); 
                        parseMode = "SCHEDULE";
                        if (!newDayMeta[parsingDay]) newDayMeta[parsingDay] = [];
                        return;
                    }
                }

                if (!parsingDay) { newOverviewMD += line + "\n"; return; }
                
                if (!newDayMeta[parsingDay]) newDayMeta[parsingDay] = [];

                // --- V14: Specific check for Cost line (Legacy support) ---
                if (trimmed.includes('ğŸ’¡') && trimmed.includes('è‡ªè²»')) {
                    newDayMeta[parsingDay].push({ title: "ç¸½è‡ªè²»é ä¼°", content: trimmed.replace(/\*\*/g, ''), type: 'cost' });
                    return;
                }
                // ---------------------------------------------------------

                if (trimmed.startsWith('###')) {
                    const title = trimmed.replace(/^###\s*/, '').trim();
                    newDayMeta[parsingDay].push({ title: title, content: "", type: 'normal' });
                    parseMode = "DYNAMIC_SECTION";
                    return;
                }

                if (parseMode === "SCHEDULE") {
                    if (trimmed.startsWith('|') && !trimmed.includes('---')) {
                        const cols = trimmed.split('|').map(c => c.replace(/\*\*/g, '').replace(/\[(.*?)\]\(.*?\)/g, '$1').trim());
                        if (cols.length >= 3) {
                            let time = cols[1]; 
                            let name = cols[2]; 
                            let location = cols[3] || ""; 
                            let note = cols[4] || ""; 
                            
                            if (time.includes('æ™‚é–“') || name.includes('è¡Œç¨‹å…§å®¹')) return;
                            
                            const isDetail = (!time || time.trim() === "");
                            if (isDetail && cols[3] && cols[3] !== "-") note = (cols[3] + " " + note).trim();
                            
                            if (name && name !== "-") {
                                newItems.push({ id: Date.now() + Math.random(), day: parsingDay, time: isDetail ? "" : time, name: name, location: location, note: note, isDetail: isDetail, img: null });
                            }
                        }
                    } else if (trimmed !== "" && !trimmed.startsWith('|')) {
                         if (newDayMeta[parsingDay].length > 0) {
                             const lastIdx = newDayMeta[parsingDay].length - 1;
                             newDayMeta[parsingDay][lastIdx].content += line + "\n";
                         }
                    }
                } else if (parseMode === "DYNAMIC_SECTION") {
                    if (newDayMeta[parsingDay].length > 0) {
                        const lastIdx = newDayMeta[parsingDay].length - 1;
                        newDayMeta[parsingDay][lastIdx].content += line + "\n";
                    }
                }
            });

            if (newItems.length > 0) {
                if (confirm(`è§£æå®Œæˆï¼æ‰¾åˆ° ${newItems.length} å€‹è¡Œç¨‹é …ç›®ã€‚æ˜¯å¦åŒ¯å…¥ï¼Ÿ`)) {
                    appData.itinerary = newItems;
                    appData.dayMeta = newDayMeta;
                    appData.overviewMarkdown = newOverviewMD; 
                    const days = [...new Set(newItems.map(i => i.day))];
                    currentDayFilter = days[0] || "Day 1";
                    document.getElementById('trip-days-count').innerText = `${days.length} å¤©è¡Œç¨‹`;
                    saveData();
                    renderTabs();
                    renderItinerary();
                    renderOverview();
                    switchTab('home');
                }
            } else {
                alert("æœªåµæ¸¬åˆ°æœ‰æ•ˆè¡Œç¨‹ï¼Œè«‹ç¢ºèª Markdown æ ¼å¼ã€‚");
            }
        }

        // 3. Render Utils
        function highlightContent(text) {
            if (!text) return "";
            return text
                .replace(/(å¿…é»|æ‹›ç‰Œ|èœå–®|é™å®š)/g, '<span class="tag-menu"><i class="fa-solid fa-star text-xs mr-1"></i>$1</span>')
                .replace(/(å¿…åƒ|ç¾å‘³|å¥½å‘³|æ¨è–¦)/g, '<span class="tag-eat"><i class="fa-solid fa-utensils text-xs mr-1"></i>$1</span>')
                .replace(/(å¿…è²·|ä¼´æ‰‹ç¦®|è—¥å¦|æŠ˜åƒ¹åˆ¸|æŠ˜æ‰£|å„ªæƒ åˆ¸)/g, '<span class="tag-buy"><i class="fa-solid fa-bag-shopping text-xs mr-1"></i>$1</span>')
                .replace(/(é ç´„|è¨‚ä½|ä»£è™Ÿ|å®¢æ»¿|æ’éšŠ|é–€ç¥¨|æ•´ç†åˆ¸)/g, '<span class="tag-res"><i class="fa-solid fa-clipboard-check text-xs mr-1"></i>$1</span>')
                .replace(/(å‘¨éŠåˆ¸|ç‰¹æ€¥|æ–°å¹¹ç·š|JR|å·´å£«|åœ°éµ|åˆ—è»Š|rapit|haruka)/gi, '<span class="tag-imp">$1</span>');
        }

        function safeMarked(text) {
            if (typeof marked === 'undefined') return text;
            try { return marked.parse(text); } catch(e) { return text; }
        }

        function renderOverview() {
            const container = document.getElementById('overview-section');
            const content = document.getElementById('overview-content');
            if (appData.overviewMarkdown && appData.overviewMarkdown.trim()) {
                container.classList.remove('hidden');
                content.innerHTML = safeMarked(appData.overviewMarkdown);
            } else {
                container.classList.add('hidden');
            }
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('day-tabs');
            const allDays = [...new Set((appData.itinerary || []).map(item => item.day || "Day 1"))];
            if (!allDays.includes(currentDayFilter) && allDays.length > 0) currentDayFilter = allDays[0];
            
            tabsContainer.innerHTML = allDays.map(day => {
                const isActive = day === currentDayFilter;
                let mainText = day;
                let subText = "";
                const matchDay = day.match(/Day\s*\d+/i);
                const matchDate = day.match(/\((.*?)\)/);
                if (matchDay) mainText = matchDay[0];
                if (matchDate) subText = matchDate[1].split(',')[0]; 
                
                return `<button onclick="switchDayFilter('${day}')" class="flex-shrink-0 px-4 py-2 rounded-xl text-center border transition-all min-w-[70px] ${isActive ? 'bg-primary text-white shadow-md border-primary ring-2 ring-blue-100' : 'bg-white text-gray-500 border-gray-200'}">
                    <div class="font-bold text-sm leading-none">${mainText}</div>
                    ${subText ? `<div class="text-[10px] opacity-80 mt-1 font-mono">${subText}</div>` : ''}
                </button>`;
            }).join('');
            
            const titleEl = document.getElementById('current-day-title');
            if(titleEl) titleEl.innerText = currentDayFilter;
        }

        function renderItinerary() {
            const list = document.getElementById('itinerary-list');
            const summaryContainer = document.getElementById('day-summary-container');
            const bottomSection = document.getElementById('bottom-summary-section');
            if(!list) return;

            list.innerHTML = '';
            summaryContainer.innerHTML = '';
            bottomSection.classList.add('hidden'); 

            updateWeatherWidget(currentDayFilter);

            const filteredItems = (appData.itinerary || []).filter(item => (item.day || "Day 1") === currentDayFilter);

            if (filteredItems.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-gray-400"><p>æœ¬æ—¥å°šç„¡è¡Œç¨‹</p></div>`;
            } else {
                filteredItems.forEach((item) => {
                    const li = document.createElement('li');
                    li.setAttribute('data-id', item.id);
                    const hlName = highlightContent(item.name);
                    const hlNote = highlightContent(item.note);
                    const deleteBtn = `<button onclick="deleteItem(${item.id})" class="ml-2 text-red-300 hover:text-red-500 transition px-2"><i class="fa-solid fa-trash-can"></i></button>`;

                    if (item.isDetail) {
                        li.className = "relative ml-8 mb-2 p-3 bg-gray-50/80 rounded-lg border-l-2 border-gray-300 group flex justify-between items-start";
                        li.innerHTML = `
                            <div class="flex-1 cursor-pointer" onclick="openEditModal(${item.id})">
                                <div class="text-sm text-gray-600 font-medium">${hlName}</div>
                                ${item.note ? `<div class="text-xs text-gray-500 mt-1">${hlNote}</div>` : ''}
                                ${item.img ? `<img src="${item.img}" class="mt-2 h-20 rounded-lg object-cover border">` : ''}
                            </div>
                            <div class="flex items-center">
                                <button onclick="triggerPhotoUpload(${item.id})" class="text-gray-300 hover:text-blue-500 photo-btn p-2"><i class="fa-solid fa-camera"></i></button>
                                ${deleteBtn}
                                <div class="drag-handle text-gray-300 cursor-grab p-2"><i class="fa-solid fa-bars"></i></div>
                            </div>`;
                    } else {
                        li.className = "relative bg-white p-4 rounded-xl shadow-sm border border-gray-100 group mb-4 transition-all hover:shadow-md";
                        li.innerHTML = `
                            <div class="absolute -left-[24px] top-6 w-3 h-3 rounded-full bg-primary border-2 border-white shadow-sm z-10"></div>
                            <div class="absolute left-[-19px] top-9 bottom-[-30px] w-0.5 bg-gray-200 -z-10"></div>
                            <div class="flex justify-between items-start">
                                <div class="drag-handle text-gray-300 hover:text-gray-500 cursor-grab pt-1 pr-3"><i class="fa-solid fa-grip-vertical"></i></div>
                                <div class="flex-1 cursor-pointer" onclick="openEditModal(${item.id})">
                                    <div class="flex items-center gap-2 mb-1"><span class="font-mono text-xl font-bold text-gray-800">${item.time}</span></div>
                                    <h4 class="font-bold text-gray-800 text-lg leading-snug">${hlName}</h4>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        ${item.location ? `<span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded"><i class="fa-solid fa-location-dot mr-1"></i>${item.location}</span>` : ''}
                                        ${item.note ? `<span class="text-xs text-gray-600">${hlNote}</span>` : ''}
                                    </div>
                                    ${item.img ? `<div class="mt-3 relative w-full h-32 bg-gray-100 rounded-lg overflow-hidden"><img src="${item.img}" class="w-full h-full object-cover"></div>` : ''}
                                </div>
                                <div class="flex flex-col gap-2 ml-3 pt-1 items-center">
                                    <button onclick="openMap('${item.name}')" class="text-gray-300 hover:text-primary p-1"><i class="fa-solid fa-diamond-turn-right text-xl"></i></button>
                                    <button onclick="triggerPhotoUpload(${item.id})" class="text-gray-300 hover:text-blue-500 photo-btn p-1"><i class="fa-solid fa-camera text-lg"></i></button>
                                    ${deleteBtn}
                                </div>
                            </div>`;
                    }
                    list.appendChild(li);
                });
            }

            const metaList = appData.dayMeta[currentDayFilter];
            let hasSummary = false;

            if (metaList && Array.isArray(metaList)) {
                metaList.forEach(section => {
                    if ((section.content && section.content.trim()) || section.title === "ç¸½è‡ªè²»é ä¼°") {
                        // V14: Special rendering for Cost card
                        if (section.type === 'cost') {
                             summaryContainer.innerHTML += `
                             <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 info-block flex items-start gap-3">
                                <i class="fa-solid fa-coins text-yellow-500 mt-1"></i>
                                <div>
                                    <h4 class="font-bold text-yellow-800 text-sm mb-1">${section.title}</h4>
                                    <div class="text-sm text-yellow-900">${safeMarked(section.content)}</div>
                                </div>
                             </div>`;
                        } else {
                            summaryContainer.innerHTML += `
                                <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 info-block">
                                    <h4 class="font-bold text-blue-800 text-sm mb-2 flex items-center">
                                        <span class="mr-2 text-blue-400">#</span>${section.title}
                                    </h4>
                                    <div class="text-sm text-gray-700 overflow-x-auto leading-relaxed">
                                        ${safeMarked(section.content)}
                                    </div>
                                </div>`;
                        }
                        hasSummary = true;
                    }
                });
            }
            
            if (hasSummary) bottomSection.classList.remove('hidden');
        }

        // 4. Interaction Functions
        function initNotepad() {
            const area = document.getElementById('notepad-area');
            if(!area) return;
            if (appData.notepadContent) area.value = appData.notepadContent;
            area.addEventListener('input', (e) => {
                appData.notepadContent = e.target.value;
                saveData();
            });
        }
        function deleteItem(id) {
            if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹é …ç›®å—ï¼Ÿ")) {
                appData.itinerary = appData.itinerary.filter(item => item.id !== id);
                saveData(); renderItinerary();
            }
        }
        function handleMDImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => parseMD(e.target.result);
            reader.readAsText(file);
            input.value = '';
        }
        function switchDayFilter(day) {
            currentDayFilter = day;
            renderTabs(); renderItinerary();
        }
        function switchTab(tabId) {
            ['home', 'itinerary', 'notepad', 'tools'].forEach(id => {
                const el = document.getElementById(`view-${id}`);
                if(el) el.classList.add('hidden');
            });
            const target = document.getElementById(`view-${tabId}`);
            if(target) target.classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-primary');
                if(btn.dataset.target === tabId) btn.classList.add('text-primary');
            });
            
            const titles = { home: "æˆ‘çš„æ—…ç¨‹", itinerary: "è¡Œç¨‹è¦åŠƒ", notepad: "éš¨æ‰‹ç­†è¨˜", tools: "æ—…è¡Œå·¥å…·" };
            const titleEl = document.getElementById('header-title');
            if(titleEl) titleEl.innerText = titles[tabId] || "æˆ‘çš„æ—…ç¨‹";
        }
        function triggerPhotoUpload(id) {
            activePhotoId = id;
            document.getElementById('photo-input').click();
        }
        function handlePhotoProcess(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('compress-canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800;
                    let w = img.width; let h = img.height;
                    if (w > maxWidth) { h *= maxWidth/w; w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    const item = appData.itinerary.find(i => i.id === activePhotoId);
                    if(item) { item.img = dataUrl; saveData(); renderItinerary(); }
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }
        function initSortable() {
            const el = document.getElementById('itinerary-list');
            if(!el) return;
            new Sortable(el, {
                handle: '.drag-handle', animation: 150, delay: 150, delayOnTouchOnly: true,
                onEnd: function (evt) {
                    const newIds = Array.from(el.children).map(li => parseFloat(li.getAttribute('data-id')));
                    const currentItems = appData.itinerary.filter(item => (item.day || "Day 1") === currentDayFilter);
                    const otherItems = appData.itinerary.filter(item => (item.day || "Day 1") !== currentDayFilter);
                    const sortedCurrent = [];
                    newIds.forEach(id => { const item = currentItems.find(i => i.id === id); if(item) sortedCurrent.push(item); });
                    appData.itinerary = [...otherItems, ...sortedCurrent];
                    appData.itinerary.sort((a,b) => (a.day||"").localeCompare(b.day||""));
                    saveData();
                }
            });
        }
        function openEditModal(id) {
            const item = appData.itinerary.find(i => i.id === id);
            if(!item) return;
            document.getElementById('edit-id').value = item.id;
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-time').value = item.time;
            document.getElementById('edit-location').value = item.location;
            document.getElementById('edit-note').value = item.note;
            document.getElementById('edit-modal').classList.remove('hidden');
        }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }
        function saveEdit() {
            const id = parseFloat(document.getElementById('edit-id').value);
            const item = appData.itinerary.find(i => i.id === id);
            if(item) {
                item.name = document.getElementById('edit-name').value;
                item.time = document.getElementById('edit-time').value;
                item.location = document.getElementById('edit-location').value;
                item.note = document.getElementById('edit-note').value;
                item.isDetail = (item.time.trim() === "");
                saveData(); renderItinerary(); closeEditModal();
            }
        }
        function addNewItem() {
            appData.itinerary.push({id: Date.now(), day: currentDayFilter, time: "10:00", name: "æ–°è¡Œç¨‹", location: "", note: "", isDetail: false, img: null});
            saveData(); renderItinerary();
        }
        function fetchExchangeRate() {
            fetch('https://api.exchangerate-api.com/v4/latest/JPY')
            .then(r=>r.json()).then(d=>{
                appData.rate = d.rates.TWD;
                const r = document.getElementById('home-rate');
                const rd = document.getElementById('rate-display');
                if(r) r.innerText = (100 * appData.rate).toFixed(2);
                if(rd) rd.innerText = `1 JPY â‰ˆ ${appData.rate} TWD`;
                saveData();
            }).catch(e=>console.log(e));
        }
        function calcCurrency(src) {
            const t = document.getElementById('curr-twd'), j = document.getElementById('curr-jpy');
            if(!t || !j) return;
            if(src==='twd') j.value = (t.value/appData.rate).toFixed(0);
            else t.value = (j.value*appData.rate).toFixed(0);
        }
        function openMap(q) { 
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank'); 
        }
        function saveData() { 
            try { localStorage.setItem('travelApp_v14', JSON.stringify(appData)); } catch(e) { console.error("Save Error", e); }
        }
        
        function exportToPDF() {
            if(appData.itinerary.length === 0) { alert("ç„¡è³‡æ–™"); return; }
            const printArea = document.getElementById('print-area');
            const days = [...new Set(appData.itinerary.map(i => i.day))].sort();
            let html = `<h1 style="text-align:center; font-size:24px; margin-bottom:20px;">${appData.tripName}</h1>`;
            if (appData.overviewMarkdown) {
                html += `<h3>è¡Œç¨‹ç¸½è¦½</h3><div>${safeMarked(appData.overviewMarkdown)}</div><hr>`;
            }
            days.forEach(day => {
                const items = appData.itinerary.filter(i => i.day === day);
                const metaList = appData.dayMeta[day]; 
                
                const rows = items.map(i => `
                    <tr><td style="width:15%;border-bottom:1px solid #ddd;padding:5px;">${i.time}</td>
                    <td style="width:40%;border-bottom:1px solid #ddd;padding:5px;"><b>${i.name}</b><br><small>${i.location}</small></td>
                    <td style="border-bottom:1px solid #ddd;padding:5px;">${i.note}</td></tr>
                `).join('');
                
                html += `<h3 style="background:#eee;padding:5px;margin-top:20px;">${day}</h3><table style="width:100%;border-collapse:collapse;font-size:12px;">${rows}</table>`;
                
                if(metaList && Array.isArray(metaList)) {
                    metaList.forEach(section => {
                        html += `
                        <div style="margin-top:10px; border-left:3px solid #0EA5E9; padding-left:10px;">
                            <b style="color:#0284c7;"># ${section.title}</b>
                            <div style="font-size:12px; margin-top:5px;">${safeMarked(section.content)}</div>
                        </div>`;
                    });
                }
            });
            printArea.innerHTML = html;
            window.print();
        }
    </script>
</body>
</html>
